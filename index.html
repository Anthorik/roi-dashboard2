<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ROI - Flotte Auto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --bg1:#0b0d10; --bg2:#111418; --card:rgba(22,26,32,.72); --text:#e7e9ee; --muted:#a4acb9; --border:rgba(255,255,255,.08); --ring:#7dd3fc; --primary:#4f46e5; --primary-d:#4338ca; --pos:#16a34a; --neg:#ef4444; }
    .light{ --bg1:#f7f8fb; --bg2:#eef1f6; --card:rgba(255,255,255,.9); --text:#0f172a; --muted:#5b6576; --border:rgba(15,15,30,.12); --ring:#0ea5e9; --primary:#2563eb; --primary-d:#1e40af; --pos:#16a34a; --neg:#ef4444; }
    body{ min-height:100vh; background: radial-gradient(1000px 600px at 15% -10%, rgba(79,70,229,.14), transparent 60%), radial-gradient(900px 560px at 100% 10%, rgba(14,165,233,.12), transparent 55%), linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:1rem; padding:1.1rem; backdrop-filter: blur(8px); }
    .btn{ background:linear-gradient(180deg,var(--primary),var(--primary-d)); color:#fff; padding:.55rem .95rem; border-radius:.7rem; font-weight:700; }
    .btn-ghost{ background:transparent; border:1px solid var(--border); border-radius:.7rem; padding:.5rem .8rem; color:var(--text); }
    input,select{ background:rgba(255,255,255,.03); color:var(--text); border:1px solid var(--border); border-radius:.6rem; padding:.55rem .65rem; width:100%; }
    label{ color:var(--muted); font-size:.9rem; }
    table{ width:100%; border-collapse:collapse; } th,td{ border-bottom:1px solid var(--border); padding:.55rem .6rem; } th{ color:var(--muted); text-align:left; }
    .pill{ font-size:.75rem; font-weight:800; padding:.2rem .55rem; border-radius:999px; }
    .grid-2{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; }
    .grid-3{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; }
    .grid-4{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; }
    @media(min-width:768px){ .grid-2{ grid-template-columns:repeat(2,1fr); } .grid-3{ grid-template-columns:repeat(3,1fr); } .grid-4{ grid-template-columns:repeat(4,1fr); } }
    .toggle{ display:flex; align-items:center; gap:.5rem; cursor:pointer; }
    .toggle input{ width:2.6rem; height:1.35rem; appearance:none; border:1px solid var(--border); border-radius:999px; position:relative; background:rgba(255,255,255,.08); }
    .toggle input:checked{ background:linear-gradient(180deg,var(--primary),var(--primary-d)); }
    .toggle input:before{ content:""; position:absolute; top:2px; left:2px; width:1.05rem; height:1.05rem; background:#fff; border-radius:999px; transition:all .18s ease; }
    .toggle input:checked:before{ transform:translateX(1.2rem); }
    .hint{ color:var(--muted); font-size:.85rem; }
    .row-selected{ outline:2px solid var(--ring); background:rgba(125,211,252,.08); }
    .compact table th, .compact table td{ padding:.25rem .35rem; }
    .compact .pill{ font-size:.7rem; padding:.15rem .4rem; }
    .badge{ padding:.1rem .45rem; border:1px solid var(--border); border-radius:.5rem; }
  </style>
</head>
<body>
  <header class="mb-6 max-w-7xl mx-auto px-4">
    <div class="flex items-center justify-between gap-4">
      <h1 class="text-2xl font-extrabold">üìä Dashboard ROI ‚Äì Flotte Auto</h1>
      <div class="flex flex-wrap items-center gap-2">
        <label class="toggle" title="Basculer th√®me clair/sombre"><span class="hint">Th√®me clair</span><input type="checkbox" id="themeToggle"/></label>
        <button id="exportJson" class="btn-ghost">Export JSON</button>
        <label class="btn-ghost cursor-pointer">Import JSON<input id="importJson" type="file" accept="application/json" class="hidden"/></label>
        <button id="exportCsv" class="btn-ghost" onclick="exportSuiviCsv()">Export CSV (Suivi)</button>
      </div>
    </div>
    <div class="mt-4 flex flex-wrap gap-2">
      <button class="btn" onclick="showTab('locations')">Locations r√©elles</button>
      <button class="btn" onclick="showTab('vehicles')">V√©hicules</button>
      <button class="btn" onclick="showTab('suivi')">Suivi mensuel</button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 space-y-6">
    <!-- LOCATIONS -->
    <section id="locations" class="card hidden">
      <h2 class="text-xl font-semibold mb-3">üìÖ Locations r√©elles</h2>
      <div class="grid-4">
        <div><label>D√©but</label><input type="date" id="date"/></div>
        <div><label>Jours</label><input type="number" id="jours" min="1" value="1"/></div>
        <div><label>Prix proprio ‚Ç¨/jour</label><input type="number" id="prixJour" min="0" step="0.1" value="30"/></div>
        <div><label>V√©hicule</label><select id="vehicule"></select></div>
        <div><label>Km totaux (optionnel)</label><input type="number" id="kms" min="0" step="1" placeholder="ex. 250"/></div>
        <div><label>Frais divers (‚Ç¨)</label><input type="number" id="extras" min="0" step="0.1" value="0"/></div>
        <div><label>Ajustement carburant (+/‚àí ‚Ç¨)</label><input type="number" id="fuelAdj" step="0.1" value="0"/></div>
        <div><label>Net re√ßu (‚Ç¨) ‚Äì override</label><input type="number" id="netOverride" step="0.1" placeholder="ex. 82.50"/></div>
        <div class="md:col-span-2"><label>Notes</label><input type="text" id="notes" placeholder="Ex. week-end, pro, remise‚Ä¶"/></div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="saveBtn" class="btn" onclick="saveLocation()">Enregistrer</button>
        <button id="cancelEditBtn" class="btn-ghost hidden" onclick="cancelEdit()">Annuler</button>
        <select id="filterVehicule" class="w-auto"></select>
        <input type="month" id="filterMonth" class="w-auto"/>
        <input type="text" id="filterNotes" class="w-auto" placeholder="#tag, notes, texte" style="min-width:180px"/>
        <label class="toggle" title="Mode compact du tableau"><span class="hint">Compact</span><input type="checkbox" id="compactToggle"/></label>
        <button class="btn-ghost" onclick="clearFilters()">Effacer filtres</button>
      </div>
      <div class="mt-4 overflow-x-auto">
        <table>
          <thead><tr><th>Date</th><th>Jours</th><th>‚Ç¨/j</th><th>Km</th><th>Frais</th><th>Carburant</th><th>V√©hicule</th><th>Net loc</th><th>Notes</th><th>Actions</th></tr></thead>
          <tbody id="locTable"></tbody>
        </table>
      </div>
      <p class="text-sm mt-2 hint">Le net affich√© suit : <i>(prix √ó jours √ó (1‚Äìcommission)) ‚àí usure ‚àí frais + carburant</i>. <b>Si ‚ÄúNet re√ßu‚Äù est saisi, il remplace ce calcul partout.</b></p>
    </section>

    <!-- VEHICLES -->
    <section id="vehicles" class="card hidden">
      <h2 class="text-xl font-semibold mb-3">üöó V√©hicules</h2>
      <div class="mb-3 flex flex-wrap gap-2">
        <button class="btn" onclick="addVehicle()">+ Ajouter un v√©hicule</button>
      </div>
      <div id="vehiclesList" class="grid-2"></div>
    </section>

    <!-- SUIVI -->
    <section id="suivi" class="card hidden">
      <h2 class="text-xl font-semibold mb-1">üìä Suivi mensuel</h2>
      <p class="hint mb-3">Astuce : choisis un v√©hicule pour voir <b>uniquement</b> ses r√©sultats. ‚ÄúTous v√©hicules‚Äù additionne tout (net ventil√© <b>jour par jour</b>). Badge d‚Äôoccupation = jours lou√©s / capacit√©.</p>
      <div class="flex flex-wrap items-center gap-2 mb-3">
        <select id="suiviVehicule" class="w-auto"></select>
        <input type="month" id="suiviMonth" class="w-auto" />
      </div>
      <div class="grid-2">
        <div><canvas id="chartNet" height="150"></canvas></div>
        <div><canvas id="chartCumul" height="150"></canvas></div>
      </div>
      <div id="monthTop" class="mt-3 text-sm"></div>
      <div id="monthBreakdown" class="mt-2 grid-2"></div>

      <!-- Vue tableau (‚Ç¨/%) + VNC -->
      <div class="mt-4 overflow-x-auto">
        <table id="suiviTable" class="w-full">
          <thead>
            <tr>
              <th>Mois</th>
              <th>Net avant fixes (‚Ç¨)</th>
              <th>Fixes (‚Ç¨)</th>
              <th>R√©sultat net (‚Ç¨)</th>
              <th>Marge (%)</th>
              <th>VNC √† fin de mois (‚Ç¨)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="hint mt-2">VNC = max(R√©siduelle, Total investi ‚àí Amort. cumul√©). Amort. cumul√© = Amort./mois √ó mois √©coul√©s depuis le <b>D√©but amort.</b></p>
    </section>
  </main>

  <script>
    // ===== Storage & State =====
    const KEY='roi_multi_v8_vnc_tableau_%_euro';
    const data = JSON.parse(localStorage.getItem(KEY) || '{}');
    const theme = data.theme || 'dark';

    const UIKEY='roi_ui';
    const ui = JSON.parse(localStorage.getItem(UIKEY) || '{"compact":false,"selectedId":null}');

    let vehicles = (data.vehicles || [
      { id:'clio',  name:'Clio',  active:true, costs:{ass:56, conn:25, ent:45, totalInvested:11659, residual:0, amortMonths:60, amortStart:null, useWear:false} },
      { id:'tesla', name:'Tesla', active:true, costs:{ass:115, conn:0,  ent:30, totalInvested:0,     residual:0, amortMonths:60, amortStart:null, useWear:false} }
    ]).map(v=>{ v.costs = {ass:0,conn:0,ent:0,totalInvested:0,residual:0,amortMonths:60,amortStart:null,useWear:false, ...(v.costs||{})}; return v; });

    let globals = data.globals || { commission:10, wearPerKm:0.12, kmInclus:100 };
    // Locations: {id, date, jours, prixJour, kms, extras, fuelAdj, notes, vehiculeId, netOverride}
    let locations = (data.locations || []).map(l=> ({...l, netOverride: (l.netOverride!==undefined ? l.netOverride : (l.net_recu!==undefined ? l.net_recu : null))}));
    let editId = null;

    // ===== Theme =====
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(){
      themeToggle.checked ? document.documentElement.classList.add('light') : document.documentElement.classList.remove('light');
      document.body.classList.toggle('compact', !!ui.compact);
    }
    themeToggle.checked=(theme==='light'); applyTheme();
    themeToggle.addEventListener('change', ()=>{ data.theme=themeToggle.checked?'light':'dark'; saveAll(); applyTheme(); });

    function saveAll(){
      localStorage.setItem(KEY, JSON.stringify({theme: themeToggle.checked?'light':'dark', vehicles, globals, locations}));
      localStorage.setItem(UIKEY, JSON.stringify(ui));
    }
    const $=id=>document.getElementById(id);
    const euro=n=>`${(n||0).toFixed(2)}‚Ç¨`;
    const monthKey=d=> d?.slice(0,7);

    // ===== Date helpers =====
    function parseDateISO(dateStr){ const [y,m,d]=dateStr.split('-').map(Number); return new Date(Date.UTC(y, m-1, d)); }
    function addDaysUTC(dateObj, n){ const d=new Date(dateObj.getTime()); d.setUTCDate(d.getUTCDate()+n); return d; }
    function monthKeyFromDate(dateObj){ const y=dateObj.getUTCFullYear(); const m=String(dateObj.getUTCMonth()+1).padStart(2,'0'); return `${y}-${m}`; }
    function splitLocationNetByMonth(l){
      const days=Math.max(1, Number(l.jours||1));
      const start=parseDateISO(l.date);
      const totalNet=netLocation(l); const perDay=totalNet/days; const map={};
      for(let i=0;i<days;i++){ const d=addDaysUTC(start, i); const mk=monthKeyFromDate(d); map[mk]=(map[mk]||0)+perDay; }
      return map;
    }
    function splitLocationDaysByMonth(l){
      const days=Math.max(1, Number(l.jours||1));
      const start=parseDateISO(l.date); const map={};
      for(let i=0;i<days;i++){ const d=addDaysUTC(start, i); const mk=monthKeyFromDate(d); map[mk]=(map[mk]||0)+1; }
      return map;
    }

    // ===== Vehicles logic =====
    function monthlyAmort(v){
      const c=v.costs||{};
      const months=Math.max(1, Number(c.amortMonths||0));
      let base=Number(c.totalInvested||0)-Number(c.residual||0);
      if(base<0) base=0;
      return base/months;
    }
    function fixedCostsMonthly(v){ const c=v.costs||{}; return (c.ass||0)+(c.conn||0)+(c.ent||0)+monthlyAmort(v); }
    function fixedCostsBreakdown(v){ const c=v.costs||{}; return { ass:c.ass||0, conn:c.conn||0, ent:c.ent||0, amort: monthlyAmort(v), base: Math.max(0,(c.totalInvested||0)-(c.residual||0)), months: Math.max(1, Number(c.amortMonths||0)) }; }
    function vehicleById(id){ return vehicles.find(v=> v.id===id); }

    // ===== Amort start / months elapsed / VNC =====
    function monthsBetween(startYYYYMM, endYYYYMM){
      if(!startYYYYMM || !/^\d{4}-\d{2}$/.test(startYYYYMM) || !/^\d{4}-\d{2}$/.test(endYYYYMM)) return 0;
      const [sy,sm]=startYYYYMM.split('-').map(Number);
      const [ey,em]=endYYYYMM.split('-').map(Number);
      return Math.max(0, (ey-sy)*12 + (em-sm) + 1); // inclusif: compte le mois en cours
    }
    function inferAmortStartForVehicle(vehId){
      // 1) premier mois de location pour ce v√©hicule si dispo, sinon mois courant
      const vehLocs = locations.filter(l=> l.vehiculeId===vehId).sort((a,b)=> new Date(a.date)-new Date(b.date));
      if(vehLocs[0]) return monthKey(vehLocs[0].date);
      const now = new Date(); const mk = `${now.getUTCFullYear()}-${String(now.getUTCMonth()+1).padStart(2,'0')}`;
      return mk;
    }
    function amortCumuleAtMonth(v, mk){
      const c=v.costs||{};
      const start = c.amortStart || inferAmortStartForVehicle(v.id);
      const elapsed = monthsBetween(start, mk);
      const perMonth = monthlyAmort(v);
      const maxCum = Math.max(0,(c.totalInvested||0)-(c.residual||0));
      return Math.min(maxCum, perMonth*elapsed);
    }
    function vncAtMonth(v, mk){
      const c=v.costs||{};
      const cum = amortCumuleAtMonth(v, mk);
      const brut = Number(c.totalInvested||0);
      const resi = Number(c.residual||0);
      return Math.max(resi, brut - cum);
    }

    // ===== Vehicles UI =====
    function renderVehiclesUI(){
      const active=vehicles.filter(v=> v.active);
      ['vehicule','filterVehicule','suiviVehicule'].forEach(id=>{
        const el=$(id); if(!el) return; el.innerHTML='';
        if(id==='filterVehicule' || id==='suiviVehicule'){
          const optAll=document.createElement('option'); optAll.value='ALL'; optAll.textContent='Tous v√©hicules'; el.appendChild(optAll);
        }
        active.forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=v.name; el.appendChild(o); });
      });
      const sel=$('suiviVehicule'); const firstActive=vehicles.find(v=>v.active); if(firstActive && (!sel.dataset.setOnce || sel.value==='ALL')){ sel.value=firstActive.id; sel.dataset.setOnce='1'; }

      // Cards
      const wrap=$('vehiclesList'); wrap.innerHTML='';
      vehicles.forEach(v=>{
        const c=v.costs||{}; const amort=monthlyAmort(v);
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`
          <div class="flex items-center justify-between">
            <input value="${v.name}" data-id="${v.id}" class="veh-name" style="max-width:240px"/>
            <label class="toggle"><span class="hint">Actif</span><input type="checkbox" ${v.active?'checked':''} data-id="${v.id}" class="veh-active"/></label>
          </div>
          <div class="grid-4 mt-3">
            <div><label>Assurance / mois</label><input type="number" step="0.1" value="${c.ass||0}" class="veh-ass" data-id="${v.id}"/></div>
            <div><label>Connect / mois</label><input type="number" step="0.1" value="${c.conn||0}" class="veh-conn" data-id="${v.id}"/></div>
            <div><label>Entretien / mois</label><input type="number" step="0.1" value="${c.ent||0}" class="veh-ent" data-id="${v.id}"/></div>
            <div><label>Amort. (auto) / mois</label><input type="number" value="${amort.toFixed(2)}" disabled/></div>
          </div>
          <div class="grid-4 mt-3">
            <div><label>Total investi (‚Ç¨)</label><input type="number" step="0.1" value="${c.totalInvested||0}" class="veh-total" data-id="${v.id}"/></div>
            <div><label>Valeur r√©siduelle (‚Ç¨)</label><input type="number" step="0.1" value="${c.residual||0}" class="veh-resid" data-id="${v.id}"/></div>
            <div><label>Dur√©e amort. (mois)</label><input type="number" value="${c.amortMonths||60}" class="veh-months" data-id="${v.id}"/></div>
            <div><label>D√©but amort. (YYYY-MM)</label><input type="month" value="${c.amortStart||''}" class="veh-amstart" data-id="${v.id}"/></div>
          </div>
          <div class="grid-3 mt-2">
            <div><label>Base amortissable</label><input type="text" value="${Math.max(0,(c.totalInvested||0)-(c.residual||0)).toFixed(2)} ‚Ç¨" disabled/></div>
            <div><label>Formule</label><input type="text" value="(Total - R√©siduelle) √∑ Mois" disabled/></div>
            <div><label>R√©sultat</label><input type="text" value="${amort.toFixed(2)} ‚Ç¨/mois" disabled/></div>
          </div>
          <div class="mt-2">
            <label class="toggle">
              <span class="hint">Usure/km activ√©e (utilise le co√ªt/km global)</span>
              <input type="checkbox" ${c.useWear ? 'checked' : ''} data-id="${v.id}" class="veh-usewear"/>
            </label>
          </div>
          <div class="mt-3 flex gap-2">
            <button class="btn" onclick="saveVehicles()">üíæ Sauvegarder</button>
            <button class="btn-ghost" onclick="removeVehicle('${v.id}')">Supprimer</button>
          </div>`;
        wrap.appendChild(card);
      });

      // Wire inputs
      wrap.querySelectorAll('.veh-name').forEach(i=> i.oninput = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.name=e.target.value; saveAll(); renderVehiclesUI(); }});
      wrap.querySelectorAll('.veh-active').forEach(i=> i.onchange = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.active=e.target.checked; saveAll(); renderVehiclesUI(); renderCharts(); }});
      wrap.querySelectorAll('.veh-ass').forEach(i=> i.oninput = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.costs.ass=Number(e.target.value||0); saveAll(); }});
      wrap.querySelectorAll('.veh-conn').forEach(i=> i.oninput = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.costs.conn=Number(e.target.value||0); saveAll(); }});
      wrap.querySelectorAll('.veh-ent').forEach(i=> i.oninput = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.costs.ent=Number(e.target.value||0); saveAll(); }});
      wrap.querySelectorAll('.veh-total').forEach(i=> i.oninput = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.costs.totalInvested=Number(e.target.value||0); saveAll(); renderVehiclesUI(); renderCharts(); }});
      wrap.querySelectorAll('.veh-resid').forEach(i=> i.oninput = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.costs.residual=Number(e.target.value||0); saveAll(); renderVehiclesUI(); renderCharts(); }});
      wrap.querySelectorAll('.veh-months').forEach(i=> i.oninput = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.costs.amortMonths=Math.max(1,Number(e.target.value||1)); saveAll(); renderVehiclesUI(); renderCharts(); }});
      wrap.querySelectorAll('.veh-amstart').forEach(i=> i.oninput = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.costs.amortStart=e.target.value||null; saveAll(); renderCharts(); }});
      wrap.querySelectorAll('.veh-usewear').forEach(i=> i.onchange = e=>{ const v=vehicleById(e.target.dataset.id); if(v){ v.costs.useWear=e.target.checked; saveAll(); renderCharts(); }});
    }
    function addVehicle(){ const id='veh_'+Math.random().toString(36).slice(2,8); vehicles.push({ id, name:'Nouveau v√©hicule', active:true, costs:{ass:0,conn:0,ent:0,totalInvested:0,residual:0,amortMonths:60,amortStart:null,useWear:false} }); saveAll(); renderVehiclesUI(); renderTable(); renderCharts(); }
    function removeVehicle(id){ if(!confirm('Supprimer ce v√©hicule ?')) return; vehicles = vehicles.filter(v=> v.id!==id); locations = locations.filter(l=> l.vehiculeId!==id); saveAll(); renderVehiclesUI(); renderTable(); renderCharts(); }
    function saveVehicles(){ saveAll(); alert('V√©hicules sauvegard√©s ‚úÖ'); }

    // ===== Tabs =====
    function showTab(id){ document.querySelectorAll('section.card').forEach(s=> s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); if(id==='suivi') renderCharts(); if(id==='vehicles') renderVehiclesUI(); }

    // ===== Locations =====
    function saveLocation(){
      const date=$('date').value; if(!date) return alert('Choisis une date');
      const netField=$('netOverride').value;
      const obj={
        date, jours:Number($('jours').value||1), prixJour:Number($('prixJour').value||0),
        kms:$('kms').value?Number($('kms').value):0, extras:Number($('extras').value||0),
        fuelAdj:Number($('fuelAdj').value||0), notes:$('notes').value||'',
        vehiculeId:$('vehicule').value, netOverride:(netField!==''?Number(netField):null)
      };
      if(editId){ locations=locations.map(l=> l.id===editId? {...l,...obj}:l); editId=null; $('cancelEditBtn').classList.add('hidden'); $('saveBtn').textContent='Enregistrer'; }
      else { const id=crypto.randomUUID?crypto.randomUUID():String(Date.now()); locations.push({id,...obj}); }
      saveAll(); clearLocForm(); renderTable(); renderCharts();
    }
    function cancelEdit(){ editId=null; clearLocForm(); $('cancelEditBtn').classList.add('hidden'); $('saveBtn').textContent='Enregistrer'; }
    function clearLocForm(){ $('date').value=''; $('jours').value=1; $('prixJour').value=30; $('kms').value=''; $('extras').value='0'; $('fuelAdj').value='0'; $('netOverride').value=''; $('notes').value=''; }
    function removeLoc(id){ locations=locations.filter(l=> l.id!==id); saveAll(); renderTable(); renderCharts(); }
    function editLoc(id){
      const l=locations.find(x=>x.id===id); if(!l) return; editId=id;
      $('date').value=l.date||''; $('jours').value=l.jours??1; $('prixJour').value=l.prixJour??0; $('kms').value=l.kms??'';
      $('extras').value=l.extras??0; $('fuelAdj').value=l.fuelAdj??0; $('notes').value=l.notes||'';
      $('netOverride').value=(l.netOverride!==null && l.netOverride!==undefined)? l.netOverride : '';
      $('vehicule').value=l.vehiculeId; $('cancelEditBtn').classList.remove('hidden'); $('saveBtn').textContent='Mettre √† jour'; window.scrollTo({top:0,behavior:'smooth'});
    }
    function duplicateLoc(id){
      const l=locations.find(x=>x.id===id); if(!l) return;
      const copy={...l, id:(crypto.randomUUID?crypto.randomUUID():String(Date.now())), notes:(l.notes? l.notes+" (dup)" : "(dup)")};
      locations.unshift(copy); saveAll(); renderTable(); renderCharts();
    }
    function makeEditable(td, initialValue, type, onSave, step){
      const input=document.createElement('input'); input.type=type||'text'; if(step) input.step=step; input.value=initialValue ?? ''; input.style.width='100%';
      input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ input.blur(); }});
      input.addEventListener('blur', ()=>{ onSave(input.value); });
      td.innerHTML=''; td.appendChild(input); input.focus(); input.select?.();
    }
    function attachInlineEditors(tr, l){
      const map=[
        {sel:'.cell-jours', field:'jours', type:'number'},
        {sel:'.cell-prix', field:'prixJour', type:'number', step:'0.1'},
        {sel:'.cell-kms', field:'kms', type:'number'},
        {sel:'.cell-extras', field:'extras', type:'number', step:'0.1'},
        {sel:'.cell-fuel', field:'fuelAdj', type:'number', step:'0.1'},
        {sel:'.cell-notes', field:'notes', type:'text'}
      ];
      map.forEach(({sel,field,type,step})=>{
        const td=tr.querySelector(sel); if(!td) return;
        td.title='Double-clic pour √©diter';
        td.ondblclick=()=>{ const startVal=(field==='notes')? (l.notes||'') : Number(l[field]||0);
          makeEditable(td, startVal, type, (val)=>{ if(field==='notes'){ l.notes=String(val||''); } else { l[field]=Number(val||0); } saveAll(); renderTable(); renderCharts(); }, step);
        };
      });
      const tdNet=tr.querySelector('.cell-net');
      if(tdNet){
        tdNet.title='Double-clic pour saisir un net re√ßu (override)';
        tdNet.ondblclick=()=>{
          const startVal=(l.netOverride!==null && l.netOverride!==undefined)? Number(l.netOverride) : netLocation(l);
          makeEditable(tdNet, startVal, 'number', (val)=>{
            const num=(val===null || val==='')? null : Number(val);
            l.netOverride=(val===null || val==='')? null : (Number.isNaN(num)? null : num); saveAll(); renderTable(); renderCharts();
          }, '0.1');
        };
      }
    }
    function netLocation(l){
      if(l.netOverride!==null && l.netOverride!==undefined && !Number.isNaN(Number(l.netOverride))){ return Number(l.netOverride); }
      const com=(globals.commission||0)/100;
      const after=(l.prixJour*(l.jours||1))*(1-com);
      const v=vehicleById(l.vehiculeId);
      const wearRate=(globals.wearPerKm||0);
      const wear=(v?.costs?.useWear ? ((l.kms||0) * wearRate) : 0);
      return after - wear - (l.extras||0) + (l.fuelAdj||0);
    }

    // Table + filtres
    function clearFilters(){ $('filterVehicule').value='ALL'; $('filterMonth').value=''; $('filterNotes').value=''; renderTable(); }
    function fillFilters(){ const filt=$('filterVehicule'); filt.innerHTML=''; const optAll=document.createElement('option'); optAll.value='ALL'; optAll.textContent='Tous v√©hicules'; filt.appendChild(optAll); vehicles.filter(v=>v.active).forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=v.name; filt.appendChild(o); }); }
    function fillVehSelect(){ const sel=$('vehicule'); sel.innerHTML=''; vehicles.filter(v=>v.active).forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=v.name; sel.appendChild(o); }); }
    function renderTable(){
      const tbody=$('locTable'); tbody.innerHTML='';
      const m=$('filterMonth').value; const vf=$('filterVehicule').value||'ALL'; const q=($('filterNotes').value||'').toLowerCase();
      const arr=locations.slice().sort((a,b)=> new Date(b.date)-new Date(a.date)).filter(l=> (!m||monthKey(l.date)===m) && (vf==='ALL'||l.vehiculeId===vf) && (!q || (l.notes||'').toLowerCase().includes(q)) );
      for(const l of arr){
        const v=vehicleById(l.vehiculeId); const net=netLocation(l);
        const overrideUsed=(l.netOverride!==null && l.netOverride!==undefined && !Number.isNaN(Number(l.netOverride)));
        const tr=document.createElement('tr'); tr.dataset.id=l.id;
        if(ui.selectedId===l.id) tr.classList.add('row-selected');
        tr.innerHTML=`
          <td class="cell-date">${l.date}</td>
          <td class="cell-jours">${l.jours||1}</td>
          <td class="cell-prix">${(Number(l.prixJour)||0).toFixed(2)}</td>
          <td class="cell-kms">${l.kms||'-'}</td>
          <td class="cell-extras">${(l.extras||0).toFixed(2)}</td>
          <td class="cell-fuel">${(l.fuelAdj||0).toFixed(2)}</td>
          <td class="cell-veh">${v? v.name : '‚Äî'}</td>
          <td class="cell-net">
            <span class="pill" style="background:${net>=0?'rgba(22,163,74,.18)':'rgba(239,68,68,.18)'};color:${net>=0?'#16a34a':'#ef4444'}" title="${overrideUsed?'Valeur saisie manuellement (override)':'Calcul automatique'}">${net.toFixed(2)}‚Ç¨</span>
            ${overrideUsed? '<span class="ml-2 text-xs badge">Saisi</span>' : ''}
          </td>
          <td class="cell-notes" title="${(l.notes||'').replace(/"/g,'&quot;')}" style="max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${l.notes||''}</td>
          <td class="whitespace-nowrap">
            <button class="btn-ghost" onclick="editLoc('${l.id}')">‚úèÔ∏è</button>
            <button class="btn-ghost" onclick="duplicateLoc('${l.id}')">üìÑ</button>
            <button class="btn-ghost" onclick="removeLoc('${l.id}')">üóëÔ∏è</button>
          </td>`;
        tr.addEventListener('click', ()=>{ ui.selectedId=l.id; saveAll(); renderTable(); });
        tbody.appendChild(tr);
        attachInlineEditors(tr, l);
      }
    }
    $('filterMonth').addEventListener('change', renderTable);
    $('filterVehicule').addEventListener('change', renderTable);
    $('filterNotes').addEventListener('input', renderTable);
    const compactToggle=$('compactToggle'); compactToggle.checked=!!ui.compact; compactToggle.addEventListener('change', ()=>{ ui.compact=compactToggle.checked; saveAll(); document.body.classList.toggle('compact', ui.compact); });

    // ===== Suivi (prorata multi-mois + occupation + VNC + tableau) =====
    let chartNet, chartCumul;
    function renderCharts(){
      const sel=$('suiviVehicule'); sel.innerHTML='';
      const active=vehicles.filter(v=>v.active);
      const optAll=document.createElement('option'); optAll.value='ALL'; optAll.textContent='Tous v√©hicules'; sel.appendChild(optAll);
      active.forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=v.name; sel.appendChild(o); });
      if(!sel.value || (!sel.dataset.setOnce && active[0])){ sel.value = active[0]?.id || 'ALL'; sel.dataset.setOnce='1'; }
      const vehF=sel.value; const mSel=$('suiviMonth').value;

      const filtered=locations.filter(l=> (vehF==='ALL' || l.vehiculeId===vehF));
      const monthsNetMap={}; const monthsDaysMap={};
      filtered.forEach(l=>{
        const piece=splitLocationNetByMonth(l);
        Object.entries(piece).forEach(([mk,val])=>{ if(!mSel || mk===mSel){ monthsNetMap[mk]=(monthsNetMap[mk]||0)+val; } });
        const pieceDays=splitLocationDaysByMonth(l);
        Object.entries(pieceDays).forEach(([mk,val])=>{ if(!mSel || mk===mSel){ monthsDaysMap[mk]=(monthsDaysMap[mk]||0)+val; } });
      });

      const months=Object.keys(monthsNetMap).sort();
      let monthlyBefore=[], monthlyFix=[], monthlyAfter=[];
      if(vehF==='ALL'){
        monthlyBefore=months.map(m=> monthsNetMap[m]||0);
        monthlyFix=months.map(_=> active.reduce((s,v)=> s+fixedCostsMonthly(v),0));
      } else {
        monthlyBefore=months.map(m=> monthsNetMap[m]||0);
        const vSel=vehicleById(vehF);
        monthlyFix=months.map(_=> fixedCostsMonthly(vSel));
      }
      monthlyAfter=monthlyBefore.map((v,i)=> v - monthlyFix[i]);

      const currentM = mSel || months[months.length-1];
      const top=$('monthTop'), bd=$('monthBreakdown');
      if(currentM){
        const before=monthsNetMap[currentM]||0;
        const fixSel=(vehF==='ALL' ? vehicles.filter(v=>v.active).reduce((s,v)=> s+fixedCostsMonthly(v),0) : fixedCostsMonthly(vehicleById(vehF)));
        const after=before - fixSel;
        const [yy,mm]=(currentM||'').split('-').map(Number);
        const daysInMonth=new Date(yy, mm, 0).getDate();
        const rentedDays=monthsDaysMap[currentM]||0;
        const capacity=(vehF==='ALL'? (daysInMonth * active.length) : daysInMonth);
        const occ=capacity>0 ? (rentedDays/capacity) : 0;
        const occPct=(occ*100).toFixed(0)+'%';
        const occStyle=(occ>=0.40)?'background:rgba(22,163,74,.18);color:#16a34a':'background:rgba(239,68,68,.18);color:#ef4444';
        // VNC (single veh or total)
        let vncDisplay='‚Äî';
        if(vehF==='ALL'){
          const totalVNC = active.reduce((s,v)=> s + vncAtMonth(v, currentM), 0);
          vncDisplay = euro(totalVNC);
        } else {
          const vSel=vehicleById(vehF);
          vncDisplay = euro(vncAtMonth(vSel, currentM));
        }

        const occBadge=`<span class="ml-2 text-xs badge" style="${occStyle}">Occupation ${occPct}</span>`;
        top.innerHTML=`${currentM||'‚Äî'} ¬∑ Net (avant fixes): <b>${euro(before)}</b> ¬∑ Fixes: <b>-${euro(fixSel)}</b> ¬∑ R√©sultat net: <b style="color:${after>=0?'var(--pos)':'var(--neg)'}">${euro(after)}</b> ¬∑ VNC: <b>${vncDisplay}</b> ${occBadge} <span class="hint">(${rentedDays}/${capacity} j)</span>`;

        // Breakdown cards
        bd.innerHTML='';
        if(vehF==='ALL'){
          active.forEach(v=>{
            const b=fixedCostsBreakdown(v);
            const card=document.createElement('div'); card.className='card';
            const vVnc = vncAtMonth(v, currentM);
            card.innerHTML=`
              <div class="text-sm hint">${v.name} ‚Äì D√©tail fixes</div>
              <div class="grid-3 mt-2">
                <div><div class="text-xs hint">Assurance</div><div class="text-lg font-bold">${euro(b.ass)}</div></div>
                <div><div class="text-xs hint">Connect</div><div class="text-lg font-bold">${euro(b.conn)}</div></div>
                <div><div class="text-xs hint">Entretien</div><div class="text-lg font-bold">${euro(b.ent)}</div></div>
                <div><div class="text-xs hint">Amort. (Total - R√©siduelle) √∑ ${b.months}</div><div class="text-lg font-bold">${euro(b.amort)}</div></div>
                <div><div class="text-xs hint">VNC (${currentM})</div><div class="text-lg font-bold">${euro(vVnc)}</div></div>
              </div>`;
            bd.appendChild(card);
          });
          const total=active.reduce((s,v)=> s+fixedCostsMonthly(v),0);
          const totalVnc=active.reduce((s,v)=> s+vncAtMonth(v,currentM),0);
          const cardTot=document.createElement('div'); cardTot.className='card';
          cardTot.innerHTML=`<div class="text-sm hint">Total v√©hicules actifs ‚Äì Fixes & VNC</div><div class="text-2xl font-extrabold">${euro(total)} fixes ¬∑ VNC ${euro(totalVnc)}</div>`;
          bd.appendChild(cardTot);
        } else {
          const v=vehicleById(vehF); const b=fixedCostsBreakdown(v); const vVnc=vncAtMonth(v,currentM);
          const card=document.createElement('div'); card.className='card';
          card.innerHTML=`
            <div class="text-sm hint">${v.name} ‚Äì D√©tail fixes</div>
            <div class="grid-3 mt-2">
              <div><div class="text-xs hint">Assurance</div><div class="text-lg font-bold">${euro(b.ass)}</div></div>
              <div><div class="text-xs hint">Connect</div><div class="text-lg font-bold">${euro(b.conn)}</div></div>
              <div><div class="text-xs hint">Entretien</div><div class="text-lg font-bold">${euro(b.ent)}</div></div>
              <div><div class="text-xs hint">Amort. (Total - R√©siduelle) √∑ ${b.months}</div><div class="text-lg font-bold">${euro(b.amort)}</div></div>
              <div><div class="text-xs hint">VNC (${currentM})</div><div class="text-lg font-bold">${euro(vVnc)}</div></div>
            </div>`;
          bd.appendChild(card);
        }

        // === Vue tableau (‚Ç¨/%, VNC) ===
        renderSuiviTable(months, monthlyBefore, monthlyFix, currentM, vehF);
      } else {
        top.textContent='Aucune donn√©e'; bd.innerHTML='';
        renderSuiviTable([], [], [], null, 'ALL');
      }

      if(chartNet) chartNet.destroy(); if(chartCumul) chartCumul.destroy();
      chartNet=new Chart(document.getElementById('chartNet').getContext('2d'), {
        type:'bar',
        data:{ labels:months, datasets:[{ label:'Net apr√®s frais fixes (‚Ç¨)', data:monthlyAfter, backgroundColor:monthlyAfter.map(v=> v>=0?'rgba(79,70,229,.9)':'rgba(239,68,68,.9)') }]},
        options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
      const cum=[]; let acc=0; for(const v of monthlyAfter){ acc+=v; cum.push(acc); }
      chartCumul=new Chart(document.getElementById('chartCumul').getContext('2d'), {
        type:'line',
        data:{ labels:months, datasets:[{ label:'Cumul (‚Ç¨)', data:cum, fill:false, borderColor:'rgba(79,70,229,.95)', tension:.25, pointRadius:3 }]},
        options:{ plugins:{legend:{display:false}} }
      });
    }
    document.getElementById('suiviVehicule')?.addEventListener('change', renderCharts);
    document.getElementById('suiviMonth')?.addEventListener('change', renderCharts);

    function renderSuiviTable(months, beforeArr, fixArr, currentM, vehF){
      const tbody = document.querySelector('#suiviTable tbody'); tbody.innerHTML='';
      const rows = months.map((mk, i)=>{
        const before = beforeArr[i]||0;
        const fixes  = fixArr[i]||0;
        const net    = before - fixes;
        const margin = before>0 ? (net/before*100) : 0;
        // VNC: single veh or total
        let vnc = 0;
        if(vehF==='ALL'){
          const act = vehicles.filter(v=>v.active);
          vnc = act.reduce((s,v)=> s + vncAtMonth(v, mk), 0);
        } else {
          const vSel = vehicleById(vehF); vnc = vncAtMonth(vSel, mk);
        }
        return { mk, before, fixes, net, margin, vnc };
      });

      // Si on filtre un mois pr√©cis, n‚Äôafficher que ce mois
      const filteredRows = currentM ? rows.filter(r=> r.mk===currentM) : rows;
      filteredRows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.mk}</td>
          <td>${euro(r.before)}</td>
          <td>${euro(r.fixes)}</td>
          <td style="color:${r.net>=0?'var(--pos)':'var(--neg)'}">${euro(r.net)}</td>
          <td>${(r.margin).toFixed(1)}%</td>
          <td>${euro(r.vnc)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ===== Export / Import =====
    document.getElementById('exportJson').addEventListener('click', ()=>{
      const blob=new Blob([JSON.stringify({theme: themeToggle.checked?'light':'dark', vehicles, globals, locations}, null, 2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download=`roi-data-${new Date().toISOString().slice(0,10)}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),0);
    });
    document.getElementById('importJson').addEventListener('change', e=>{
      const f=e.target.files?.[0]; if(!f) return; const r=new FileReader();
      r.onload=()=>{ try{
        const d=JSON.parse(r.result);
        if(d.theme){ themeToggle.checked=(d.theme==='light'); applyTheme(); }
        if(Array.isArray(d.vehicles)) vehicles=d.vehicles.map(v=> ({...v, costs:{ass:0,conn:0,ent:0,totalInvested:0,residual:0,amortMonths:60,amortStart:null,useWear:false, ...(v.costs||{})}}));
        if(d.globals) globals=d.globals;
        if(Array.isArray(d.locations)) locations=d.locations.map(l=> ({...l, netOverride: (l.netOverride!==undefined ? l.netOverride : (l.net_recu!==undefined ? l.net_recu : null))}));
        saveAll(); renderVehiclesUI(); fillVehSelect(); fillFilters(); renderTable(); renderCharts(); alert('Import r√©ussi ‚úÖ');
      }catch(_){ alert('Fichier invalide ‚ùå'); } };
      r.readAsText(f);
    });

    // Export CSV: suivi (mois courant ou tout si pas de filtre)
    function exportSuiviCsv(){
      const vehF = $('suiviVehicule')?.value || 'ALL';
      const mSel = $('suiviMonth')?.value || '';
      const filtered=locations.filter(l=> (vehF==='ALL' || l.vehiculeId===vehF));
      const monthsNetMap={}; const monthsFixMap={};
      filtered.forEach(l=>{
        const piece=splitLocationNetByMonth(l);
        Object.entries(piece).forEach(([mk,val])=>{ if(!mSel || mk===mSel){ monthsNetMap[mk]=(monthsNetMap[mk]||0)+val; } });
      });
      const months=Object.keys(monthsNetMap).sort();
      const rows = months.map(mk=>{
        const before = monthsNetMap[mk]||0;
        let fixes = 0;
        if(vehF==='ALL'){ fixes = vehicles.filter(v=>v.active).reduce((s,v)=> s+fixedCostsMonthly(v),0); }
        else { fixes = fixedCostsMonthly(vehicleById(vehF)); }
        const net = before - fixes;
        const margin = before>0 ? (net/before*100) : 0;
        const vnc = (vehF==='ALL') ? vehicles.filter(v=>v.active).reduce((s,v)=> s+vncAtMonth(v,mk),0) : vncAtMonth(vehicleById(vehF), mk);
        return { mk, before, fixes, net, margin, vnc };
      });
      const header = "mois;net_avant_fixes;fixes;net;marge_pct;vnc\n";
      const body = rows.map(r=> [r.mk, r.before.toFixed(2), fixesRound(r.fixes), r.net.toFixed(2), r.margin.toFixed(1), r.vnc.toFixed(2)].join(';')).join('\n');
      const blob = new Blob([header+body], {type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`suivi-${vehF}-${mSel||'all'}.csv`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),0);
      function fixesRound(n){ return (n||0).toFixed(2); }
    }

    // ===== Raccourcis clavier =====
    function isTypingInInput(){ const a=document.activeElement; return a && (a.tagName==='INPUT' || a.tagName==='TEXTAREA'); }
    document.addEventListener('keydown', (e)=>{
      if(e.ctrlKey && e.key.toLowerCase()==='s'){ e.preventDefault(); saveLocation(); return; }
      if(isTypingInInput()) return;
      if(e.key.toLowerCase()==='n'){ e.preventDefault(); showTab('locations'); $('date').focus(); return; }
      if(e.key.toLowerCase()==='d' && ui.selectedId){ e.preventDefault(); duplicateLoc(ui.selectedId); return; }
      if(e.key.toLowerCase()==='e' && ui.selectedId){ e.preventDefault(); editLoc(ui.selectedId); return; }
      if((e.key==='Delete' || e.key==='Backspace') && ui.selectedId){ e.preventDefault(); removeLoc(ui.selectedId); return; }
    });

    // ===== Init =====
    function init(){
      if(!vehicles.find(v=>v.id==='clio')) vehicles.push({ id:'clio', name:'Clio', active:true, costs:{ass:56,conn:25,ent:45,totalInvested:11659,residual:0,amortMonths:60,amortStart:null,useWear:false} });
      if(!vehicles.find(v=>v.id==='tesla')) vehicles.push({ id:'tesla', name:'Tesla', active:true, costs:{ass:115,conn:0,ent:30,totalInvested:0,residual:0,amortMonths:60,amortStart:null,useWear:false} });
      renderVehiclesUI(); fillVehSelect(); fillFilters(); renderTable(); renderCharts(); showTab('suivi');
    }
    init();
  </script>
</body>
</html>
