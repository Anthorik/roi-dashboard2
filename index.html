
<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Dashboard ROI - Flotte Auto</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { background-color: #0b0d10; color: white; font-family: sans-serif; }
    .card { background: #111418; padding: 1rem; border-radius: .75rem; margin-bottom: 1rem; }
    input, select { background: #1c1f24; border: 1px solid #333; color: white; padding: .5rem; border-radius: .5rem; width: 100%; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #333; padding: .5rem; text-align: left; }
    .btn { background-color: #4f46e5; padding: .5rem 1rem; border-radius: .5rem; color: white; font-weight: bold; }
    .pill { font-weight: bold; padding: .2rem .6rem; border-radius: 9999px; }
  </style>
</head>
<body>
<div class="max-w-6xl mx-auto p-4">
<h1 class="text-2xl font-bold mb-4">üìä Dashboard ROI ‚Äì Flotte Auto</h1>
<div class="card">
<h2 class="text-xl mb-3">üìÖ Locations r√©elles</h2>
<div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
<div><label>Date</label><input id="date" type="date"/></div>
<div><label>Jours</label><input id="jours" type="number" value="1"/></div>
<div><label>‚Ç¨/jour</label><input id="prixJour" type="number" value="30"/></div>
<div><label>V√©hicule</label><input id="vehicule" value="Clio"/></div>
<div><label>Km totaux</label><input id="kms" type="number"/></div>
<div><label>Frais km supp (‚Ç¨)</label><input id="kmSupp" type="number" value="0"/></div>
<div><label>Frais divers (‚Ç¨)</label><input id="extras" type="number" value="0"/></div>
<div><label>Carburant ¬± (‚Ç¨)</label><input id="fuelAdj" type="number" value="0"/></div>
<div><label>Plateforme</label>
<select id="plateforme">
<option value="getaround">Getaround</option>
<option value="turo">Turo</option>
</select>
</div>
<div class="md:col-span-2"><label>Notes</label><input id="notes" type="text"/></div>
</div>
<button class="btn" onclick="addLocation()">Enregistrer</button>
</div>
<div class="card">
<table>
<thead>
<tr>
<th>Date</th>
<th>Jours</th>
<th>Net</th>
<th>V√©hicule</th>
<th>Plateforme</th>
<th>Notes</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="locTable"></tbody>
</table>
</div>
</div>
<script>
    const commissionRate = {
      getaround: 0.10,
      turo: 0.244, // Exemple de Turo : 37,10 + 7,42 = ~24,4 %
    };
    const locations = [];

    function euro(n) { return Number(n).toFixed(2) + "‚Ç¨"; }

    function calcNet(loc) {
      const brut = loc.prixJour * loc.jours;
      const commission = brut * (commissionRate[loc.plateforme] || 0);
      const net = brut - commission + Number(loc.kmSupp) - Number(loc.extras) + Number(loc.fuelAdj);
      return net;
    }

    function addLocation() {
      const loc = {
        date: document.getElementById('date').value,
        jours: Number(document.getElementById('jours').value),
        prixJour: Number(document.getElementById('prixJour').value),
        kms: Number(document.getElementById('kms').value),
        kmSupp: Number(document.getElementById('kmSupp').value),
        extras: Number(document.getElementById('extras').value),
        fuelAdj: Number(document.getElementById('fuelAdj').value),
        plateforme: document.getElementById('plateforme').value,
        vehicule: document.getElementById('vehicule').value,
        notes: document.getElementById('notes').value,
      };
      locations.push(loc);
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById('locTable');
      tbody.innerHTML = "";
      for (const loc of locations) {
        const net = calcNet(loc);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${loc.date}</td><td>${loc.jours}</td><td>${euro(loc.prixJour)}</td>
          <td>${euro(loc.kmSupp)}</td><td>${euro(loc.extras)}</td><td>${euro(loc.fuelAdj)}</td>
          <td>${loc.plateforme}</td>
          <td><span class="pill" style="background:${net>=0?'#166534':'#7f1d1d'};">${euro(net)}</span></td>
          <td><button onclick="this.parentNode.parentNode.remove()">‚ùå</button></td>
        `;
        tbody.appendChild(tr);
      }
    }
  </script>

<script>
// Patch netLocation()
function netLocation(l){
  return Number(l.netManuel || 0);
}

// Patch saveLocation()
function saveLocation(){
  const date = $('date').value; if(!date) return alert('Choisis une date');
  const obj = {
    date,
    jours: Number($('jours').value || 1),
    netManuel: Number($('netLocation').value || 0),
    notes: $('notes').value || '',
    vehiculeId: $('vehicule').value,
    plateforme: $('plateforme')?.value || 'getaround'
  };
  if(editId){
    locations = locations.map(l => l.id === editId ? {...l, ...obj} : l);
    editId = null;
    $('cancelEditBtn').classList.add('hidden');
    $('saveBtn').textContent = 'Enregistrer';
  } else {
    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
    locations.push({id, ...obj});
  }
  saveAll();
  clearLocForm();
  renderTable();
  renderCharts();
}

// Patch editLoc()
function editLoc(id){
  const l = locations.find(x => x.id === id); if(!l) return;
  editId = id;
  $('date').value = l.date || '';
  $('jours').value = l.jours ?? 1;
  $('netLocation').value = l.netManuel ?? 0;
  $('vehicule').value = l.vehiculeId;
  $('plateforme').value = l.plateforme || 'getaround';
  $('notes').value = l.notes || '';
  $('cancelEditBtn').classList.remove('hidden');
  $('saveBtn').textContent = 'Mettre √† jour';
  window.scrollTo({top: 0, behavior: 'smooth'});
}
</script>
<script>
// Patch renderTable()
function renderTable() {
  const tbody = $('locTable'); tbody.innerHTML = '';
  const m = $('filterMonth').value;
  const vf = $('filterVehicule').value || 'ALL';
  const arr = locations.slice().sort((a,b)=> new Date(b.date)-new Date(a.date))
    .filter(l => (!m || monthKey(l.date) === m) && (vf === 'ALL' || l.vehiculeId === vf));
  for (const l of arr) 
const v=vehicleById(l.vehiculeId);
const net=netLocation(l);
const tr=document.createElement('tr');
tr.innerHTML=`
  <td>\${l.date}</td>
  <td>\${l.jours || 1}</td>
  <td><span class="pill" style="background:rgba(22,163,74,.18);color:#16a34a">\${net.toFixed(2)}‚Ç¨</span></td>
  <td>\${v ? v.name : '‚Äî'}</td>
  <td>\${l.plateforme || '‚Äî'}</td>
  <td title="\${(l.notes || '').replace(/"/g,'&quot;')}" style="max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">\${l.notes || ''}</td>
  <td class="whitespace-nowrap">
    <button class="btn-ghost" onclick="editLoc('\${l.id}')">‚úèÔ∏è</button>
    <button class="btn-ghost" onclick="removeLoc('\${l.id}')">üóëÔ∏è</button>
  </td>`;
tbody.appendChild(tr);

}
</script></body>
</html>
