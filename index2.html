<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ROI - Flotte Auto (v11)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.32/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root { --bg1:#0b0d10; --bg2:#111418; --card:rgba(22,26,32,.72); --text:#e7e9ee; --muted:#a4acb9; --border:rgba(255,255,255,.08); --ring:#7dd3fc; --primary:#4f46e5; --primary-d:#4338ca; --pos:#16a34a; --neg:#ef4444; --warn:#f59e0b; }
    .light{ --bg1:#f7f8fb; --bg2:#eef1f6; --card:rgba(255,255,255,.9); --text:#0f172a; --muted:#5b6576; --border:rgba(15,15,30,.12); --ring:#0ea5e9; --primary:#2563eb; --primary-d:#1e40af; --pos:#16a34a; --neg:#ef4444; --warn:#f59e0b; }
    body{ min-height:100vh; background: radial-gradient(1000px 600px at 15% -10%, rgba(79,70,229,.14), transparent 60%), radial-gradient(900px 560px at 100% 10%, rgba(14,165,233,.12), transparent 55%), linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:1rem; padding:1.1rem; backdrop-filter: blur(8px); }
    .btn{ background:linear-gradient(180deg,var(--primary),var(--primary-d)); color:#fff; padding:.55rem .95rem; border-radius:.7rem; font-weight:700; }
    .btn-ghost{ background:transparent; border:1px solid var(--border); border-radius:.7rem; padding:.5rem .8rem; color:var(--text); }
    input,select{ background:rgba(255,255,255,.03); color:var(--text); border:1px solid var(--border); border-radius:.6rem; padding:.55rem .65rem; width:100%; transition:border-color .2s; }
    input.error{ border-color:var(--neg); box-shadow:0 0 0 2px rgba(239,68,68,.2); }
    input.valid{ border-color:var(--pos); box-shadow:0 0 0 2px rgba(22,163,74,.2); }
    label{ color:var(--muted); font-size:.9rem; }
    table{ width:100%; border-collapse:collapse; } th,td{ border-bottom:1px solid var(--border); padding:.55rem .6rem; } th{ color:var(--muted); text-align:left; }
    .pill{ font-size:.75rem; font-weight:800; padding:.2rem .55rem; border-radius:999px; }
    .grid-2{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; }
    .grid-3{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; }
    .grid-4{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; }
    @media(min-width:768px){ .grid-2{ grid-template-columns:repeat(2,1fr); } .grid-3{ grid-template-columns:repeat(3,1fr); } .grid-4{ grid-template-columns:repeat(4,1fr); } }
    .toggle{ display:flex; align-items:center; gap:.5rem; cursor:pointer; }
    .toggle input{ width:2.6rem; height:1.35rem; appearance:none; border:1px solid var(--border); border-radius:999px; position:relative; background:rgba(255,255,255,.08); }
    .toggle input:checked{ background:linear-gradient(180deg,var(--primary),var(--primary-d)); }
    .toggle input:before{ content:""; position:absolute; top:2px; left:2px; width:1.05rem; height:1.05rem; background:#fff; border-radius:999px; transition:all .18s ease; }
    .toggle input:checked:before{ transform:translateX(1.2rem); }
    .hint{ color:var(--muted); font-size:.85rem; }
    .row-selected{ outline:2px solid var(--ring); background:rgba(125,211,252,.08); }
    .compact table th, .compact table td{ padding:.25rem .35rem; }
    .compact .pill{ font-size:.7rem; padding:.15rem .4rem; }
    .toast{ position:fixed; top:20px; right:20px; padding:1rem 1.5rem; border-radius:.5rem; color:#fff; z-index:1000; transform:translateX(100%); transition:transform .3s; font-weight:500; }
    .toast.show{ transform:translateX(0); }
    .occ-badge, .alert-badge{ padding:.2rem .5rem; border-radius:.5rem; font-size:.8rem; font-weight:600; }
    .occ-good{ background:var(--pos); color:#fff; }
    .occ-warn{ background:var(--warn); color:#fff; }
    .occ-bad{ background:var(--neg); color:#fff; }
    .alert-warn{ background:var(--warn); color:#fff; }
    .alert-bad{ background:var(--neg); color:#fff; }
    .highlight{ background:rgba(79,70,229,.2); }
    .quick-stats{ display:flex; justify-content:space-around; flex-wrap:wrap; gap:1rem; margin-bottom:1rem; }
    .stat-card{ flex:1; min-width:150px; text-align:center; padding:1rem; border-radius:.75rem; background:var(--card); }
    .preview-breakdown{ background:var(--card); border-radius:1rem; padding:1.25rem; margin-top:1rem; border-left:4px solid var(--primary); box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); }
    .preview-header{ display:flex; align-items:center; gap:0.75rem; margin-bottom:1rem; padding-bottom:0.75rem; border-bottom:1px solid var(--border); }
    .preview-icon{ font-size:1.5rem; }
    .preview-vehicle{ font-weight:600; font-size:1.1rem; }
    .preview-dates{ color:var(--muted); font-size:0.9rem; }
    .breakdown-line{ display:flex; justify-content:space-between; align-items:center; margin:0.5rem 0; padding:0.25rem 0; }
    .breakdown-label{ display:flex; align-items:center; gap:0.5rem; flex:1; }
    .breakdown-value{ font-weight:500; text-align:right; min-width:60px; }
    .breakdown-total{ font-weight:bold; border-top:2px solid var(--border); padding-top:0.75rem; margin-top:0.75rem; display:flex; justify-content:space-between; align-items:center; background:rgba(79,70,229,0.1); padding:0.75rem; border-radius:0.5rem; }
    .breakdown-neg{ color:var(--neg); }
    .breakdown-pos{ color:var(--pos); }
    @media (max-width: 480px) { .grid-4 { grid-template-columns: repeat(2, 1fr); } .btn { padding: .4rem .8rem; font-size: .875rem; } .quick-stats { flex-direction:column; } .preview-header { flex-direction:column; align-items:flex-start; gap:0.25rem; } }
  </style>
</head>
<body>
  <header class="mb-6 max-w-7xl mx-auto px-4">
    <div class="flex items-center justify-between gap-4">
      <h1 class="text-2xl font-extrabold">üìä Dashboard ROI ‚Äì Flotte Auto (v11)</h1>
      <div class="flex flex-wrap items-center gap-2">
        <label class="toggle" title="Basculer th√®me clair/sombre"><span class="hint">Th√®me clair</span><input type="checkbox" id="themeToggle"/></label>
        <button id="exportJson" class="btn-ghost">Export JSON</button>
        <label class="btn-ghost cursor-pointer">Import JSON<input id="importJson" type="file" accept="application/json" class="hidden"/></label>
        <button id="exportCsv" class="btn-ghost">Export CSV</button>
        <button id="exportPdf" class="btn-ghost">Export PDF</button>
      </div>
    </div>
    <div id="quickStats" class="quick-stats hidden"></div>
    <div class="mt-4 flex flex-wrap gap-2">
      <button class="btn" onclick="UIManager.showTab('locations')">Locations r√©elles</button>
      <button class="btn" onclick="UIManager.showTab('vehicles')">V√©hicules</button>
      <button class="btn" onclick="UIManager.showTab('suivi')">Suivi mensuel</button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 space-y-6">
    <!-- LOCATIONS (Preview plus visuelle) -->
    <section id="locations" class="card hidden">
      <h2 class="text-xl font-semibold mb-3">üìÖ Locations r√©elles</h2>
      <p class="hint mb-3">Saisie simplifi√©e : Remplis les bases, vois le breakdown visuel auto, et enregistre. Commission globale et usure via Globals/V√©hicules.</p>
      <div class="grid-4">
        <div><label>D√©but *</label><input type="date" id="date" required oninput="updatePreview()"/></div>
        <div><label>Fin (auto si jours)</label><input type="date" id="endDate" oninput="updatePreview()"/></div>
        <div><label>Jours *</label><input type="number" id="jours" min="1" value="1" required oninput="updatePreview()"/></div>
        <div><label>V√©hicule *</label><select id="vehicule" required onchange="updatePreview()"></select></div>
        <div><label>Tarif total (‚Ç¨) *</label><input type="number" id="tarifTotal" min="0.01" step="0.1" value="44" required oninput="updatePreview()"/></div>
        <div><label>Km inclus (d√©faut 400)</label><input type="number" id="kmInclus" min="0" value="400" oninput="updatePreview()"/></div>
        <div><label>Km parcourus (total)</label><input type="number" id="kms" min="0" step="1" placeholder="ex. 427" oninput="updatePreview()"/></div>
        <div><label>Frais service (%) (d√©faut 10)</label><input type="number" id="fraisServicePct" min="0" max="100" value="10" step="0.1" oninput="updatePreview()"/></div>
        <div class="md:col-span-2"><label>Notes</label><input type="text" id="notes" placeholder="Ex. #week-end #pro, remise‚Ä¶" oninput="updatePreview()"/></div>
      </div>
      <!-- Preview Breakdown Visuelle -->
      <div id="previewBreakdown" class="preview-breakdown hidden">
        <div class="preview-header">
          <span class="preview-icon">üöó</span>
          <div>
            <div id="prevVehicle" class="preview-vehicle">V√©hicule</div>
            <div id="prevDates" class="preview-dates">Dates</div>
          </div>
        </div>
        <div class="breakdown-line">
          <div class="breakdown-label">
            <span>üí∞ Tarif base</span>
          </div>
          <span id="prevTarif" class="breakdown-value">0‚Ç¨</span>
        </div>
        <div class="breakdown-line">
          <div class="breakdown-label">
            <span>üìã Frais service (<span id="prevFraisPct">10</span>%)</span>
          </div>
          <span id="prevFrais" class="breakdown-value breakdown-neg">-0‚Ç¨</span>
        </div>
        <div class="breakdown-line">
          <div class="breakdown-label">
            <span>‚õΩ Carburant surplus (<span id="prevExtraKm">0</span> km √ó 0.14‚Ç¨)</span>
          </div>
          <span id="prevCarburant" class="breakdown-value breakdown-neg">-0‚Ç¨</span>
        </div>
        <div class="breakdown-line">
          <div class="breakdown-label">
            <span>‚öôÔ∏è Usure & extras (auto)</span>
          </div>
          <span id="prevUsure" class="breakdown-value breakdown-neg">-0‚Ç¨</span>
        </div>
        <div class="breakdown-total">
          <div class="breakdown-label">
            <span>üíµ Vos revenus net</span>
          </div>
          <span id="prevNet" class="breakdown-value breakdown-pos">0‚Ç¨</span>
        </div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="saveBtn" class="btn" onclick="LocationManager.save()">Enregistrer</button>
        <button id="cancelEditBtn" class="btn-ghost hidden" onclick="LocationManager.cancelEdit()">Annuler</button>
        <select id="filterVehicule" class="w-auto"></select>
        <input type="month" id="filterMonth" class="w-auto"/>
        <input type="text" id="filterNotes" class="w-auto" placeholder="#tag, notes, texte" style="min-width:180px"/>
        <label class="toggle" title="Mode compact du tableau"><span class="hint">Compact</span><input type="checkbox" id="compactToggle"/></label>
        <button class="btn-ghost" onclick="UIManager.clearFilters()">Effacer filtres</button>
      </div>
      <div class="mt-4 overflow-x-auto">
        <table>
          <thead><tr><th>Date</th><th>Jours</th><th>Tarif ‚Ç¨</th><th>Km</th><th>Frais %</th><th>Carb. ¬±</th><th>V√©hicule</th><th>Net loc</th><th>Notes</th><th>Actions</th></tr></thead>
          <tbody id="locTable"></tbody>
        </table>
      </div>
      <p class="text-sm mt-2 hint">Net = Tarif total √ó (1 - frais%) - (km extra √ó 0.14‚Ç¨) - usure - extras. Override possible via edit.</p>
    </section>

    <!-- VEHICLES (inchang√©) -->
    <section id="vehicles" class="card hidden">
      <h2 class="text-xl font-semibold mb-3">üöó V√©hicules</h2>
      <div class="mb-3 flex flex-wrap gap-2">
        <button class="btn" onclick="VehicleManager.add()">+ Ajouter un v√©hicule</button>
      </div>
      <div id="vehiclesList" class="grid-2"></div>
    </section>

    <!-- SUIVI (inchang√©) -->
    <section id="suivi" class="card hidden">
      <h2 class="text-xl font-semibold mb-1">üìä Suivi mensuel</h2>
      <p class="hint mb-3">Astuce : choisis un v√©hicule pour voir <b>uniquement</b> ses r√©sultats. ‚ÄúTous v√©hicules‚Äù additionne tout (net ventil√© <b>jour par jour</b>). Badge d‚Äôoccupation = jours lou√©s / capacit√©.</p>
      <div class="flex flex-wrap items-center gap-2 mb-3">
        <select id="suiviVehicule" class="w-auto"></select>
        <input type="month" id="suiviMonth" class="w-auto" />
        <label class="toggle" title="Afficher la marge (%) au lieu des ‚Ç¨">
          <span class="hint">Mode %</span>
          <input type="checkbox" id="modePercent"/>
        </label>
        <button id="exportSuiviCsv" class="btn-ghost">Export Suivi (CSV)</button>
      </div>
      <div id="globalROI" class="card mb-3 p-4 text-center">
        <h3 class="text-lg font-bold">ROI Global</h3>
        <p id="roiValue" class="text-2xl" style="color:var(--neg);">‚Äî</p>
        <p class="hint">Cumul net / Investissement total</p>
      </div>
      <div id="priceSuggestion" class="card mb-3 p-2 text-center hidden">
        <p class="hint">Suggestion prix : <span id="suggText">‚Äî</span></p>
      </div>
      <div class="grid-3">
        <div><canvas id="chartNet" height="150"></canvas></div>
        <div><canvas id="chartCumul" height="150"></canvas></div>
        <div><canvas id="chartPredict" height="150"></canvas></div>
      </div>
      <div id="monthTop" class="mt-3 text-sm"></div>
      <div id="monthBreakdown" class="mt-2 grid-2"></div>
      <div class="mt-4 overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>Mois</th>
              <th>Net avant fixes (‚Ç¨)</th>
              <th>Fixes (‚Ç¨)</th>
              <th>Net apr√®s (‚Ç¨)</th>
              <th>Marge (%)</th>
              <th>Occupation</th>
              <th>VNC (‚Ç¨)</th>
            </tr>
          </thead>
          <tbody id="suiviTable"></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    // ===== Managers (Modular JS - v11 avec preview visuelle) =====
    class DataManager {
      static KEY = 'roi_multi_v11_suivi_vnc_percent_table';
      static UIKEY = 'roi_ui_v11';
      static data = JSON.parse(localStorage.getItem(this.KEY) || '{}');
      static ui = JSON.parse(localStorage.getItem(this.UIKEY) || '{"compact":false,"selectedId":null}');

      static get theme() { return this.data.theme || 'dark'; }
      static set theme(val) { this.data.theme = val; this.saveAll(); }

      static saveAll() {
        localStorage.setItem(this.KEY, JSON.stringify({theme: this.theme, vehicles: VehicleManager.vehicles, globals: GlobalManager.globals, locations: LocationManager.locations}));
        localStorage.setItem(this.UIKEY, JSON.stringify(this.ui));
      }

      static validateLocation(obj) {
        const errors = [];
        if (!obj.date) errors.push('Date requise');
        if (obj.jours < 1) errors.push('Jours ‚â•1');
        if (obj.tarifTotal <= 0) errors.push('Tarif >0');
        if (!obj.vehiculeId || !VehicleManager.getById(obj.vehiculeId)) errors.push('V√©hicule requis');
        return errors;
      }

      static showToast(msg, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.style.background = type === 'error' ? 'var(--neg)' : type === 'success' ? 'var(--pos)' : 'var(--primary)';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
      }

      static autoBackup() {
        setInterval(() => {
          if (confirm('Sauvegarde auto d√©tect√©e. Exporter maintenant ?')) {
            UIManager.exportJson();
          }
        }, 300000); // 5min
      }

      static importData(imported) {
        try {
          if (imported.theme) this.theme = imported.theme;
          if (Array.isArray(imported.vehicles)) {
            VehicleManager.vehicles = imported.vehicles.map(v => ({
              ...v,
              costs: {
                ...v.costs,
                residual: v.costs?.residual ?? 0,
                useWear: v.costs?.useWear ?? false,
                acqStart: v.costs?.acqStart ?? '',
                kmActuels: v.costs?.kmActuels ?? 0,
                maintenanceIntervalKm: v.costs?.maintenanceIntervalKm ?? 15000
              }
            }));
          }
          if (imported.globals) GlobalManager.globals = imported.globals;
          if (Array.isArray(imported.locations)) {
            LocationManager.locations = imported.locations.map(l => ({
              ...l,
              netOverride: (l.netOverride !== undefined ? l.netOverride : (l.net_recu !== undefined ? l.net_recu : null)),
              tarifTotal: l.tarifTotal || (l.prixJour * l.jours || 0),
              fraisServicePct: l.fraisServicePct || 10,
              kmInclus: l.kmInclus || 400,
              prixJour: undefined // Migration
            }));
          }
          this.saveAll();
          VehicleManager.render();
          LocationManager.fillVehSelect();
          UIManager.fillFilters();
          LocationManager.renderTable();
          SuiviManager.render();
          DataManager.showToast('Import r√©ussi ‚úÖ', 'success');
        } catch (e) {
          DataManager.showToast('Fichier invalide ‚ùå', 'error');
        }
      }
    }

    function validateInput(el) {
      const val = el.value.trim();
      if (el.required && !val) {
        el.classList.add('error');
        el.classList.remove('valid');
      } else if (el.type === 'number' && Number(val) < (el.min || 0)) {
        el.classList.add('error');
        el.classList.remove('valid');
      } else {
        el.classList.remove('error');
        el.classList.add('valid');
      }
    }

    function updatePreview() {
      const date = UIManager.$('date').value;
      const endDate = UIManager.$('endDate').value;
      const jours = Number(UIManager.$('jours').value || 1);
      const tarifTotal = Number(UIManager.$('tarifTotal').value || 0);
      const kmInclus = Number(UIManager.$('kmInclus').value || 400);
      const kms = Number(UIManager.$('kms').value || 0);
      const fraisServicePct = Number(UIManager.$('fraisServicePct').value || 10) / 100;
      const vehId = UIManager.$('vehicule').value;
      const v = VehicleManager.getById(vehId);
      const com = (GlobalManager.globals.commission || 10) / 100;
      const wearRate = GlobalManager.globals.wearPerKm || 0.12;

      if (!date || !vehId || tarifTotal <= 0) {
        UIManager.$('previewBreakdown').classList.add('hidden');
        return;
      }

      // Calcul fin si pas saisie
      let calcEndDate = endDate;
      if (!endDate && date) {
        const start = new Date(date);
        start.setDate(start.getDate() + jours - 1);
        calcEndDate = start.toISOString().split('T')[0];
      }

      const extraKm = Math.max(0, kms - kmInclus);
      const fraisService = tarifTotal * fraisServicePct;
      const carburantSurplus = extraKm * 0.14;
      const usure = v?.costs?.useWear ? (kms * wearRate) : 0;
      const net = tarifTotal * (1 - com - fraisServicePct) - carburantSurplus - usure;

      // Update header
      UIManager.$('prevVehicle').textContent = v ? v.name : 'V√©hicule';
      UIManager.$('prevDates').textContent = `${date} ‚Üí ${calcEndDate || ''} (${jours} j, ${kmInclus} km inclus)`;

      // Update lines
      UIManager.$('prevTarif').textContent = `${tarifTotal.toFixed(2)}‚Ç¨`;
      UIManager.$('prevFraisPct').textContent = (fraisServicePct * 100).toFixed(1);
      UIManager.$('prevFrais').textContent = `-${fraisService.toFixed(2)}‚Ç¨`;
      UIManager.$('prevFrais').className = 'breakdown-value breakdown-neg';
      UIManager.$('prevExtraKm').textContent = extraKm;
      UIManager.$('prevCarburant').textContent = `-${carburantSurplus.toFixed(2)}‚Ç¨`;
      UIManager.$('prevCarburant').className = 'breakdown-value breakdown-neg';
      UIManager.$('prevUsure').textContent = `-${usure.toFixed(2)}‚Ç¨`;
      UIManager.$('prevUsure').className = 'breakdown-value breakdown-neg';
      UIManager.$('prevNet').textContent = `${net.toFixed(2)}‚Ç¨`;
      UIManager.$('prevNet').className = `breakdown-value ${net >= 0 ? 'breakdown-pos' : 'breakdown-neg'}`;

      UIManager.$('previewBreakdown').classList.remove('hidden');
    }

    // ... (Reste du code identique √† v11 pr√©c√©dent, avec UIManager, VehicleManager, LocationManager, SuiviManager, Calculator)
    // Pour brevit√©, les classes non modifi√©es sont omises, mais inclues dans le full code.

    class UIManager {
      // ... (identique)
    }

    class GlobalManager {
      // ... (identique)
    }

    class VehicleManager {
      // ... (identique)
    }

    class LocationManager {
      // ... (identique, avec save/clearForm utilisant nouveaux champs)
    }

    class SuiviManager {
      // ... (identique)
    }

    class Calculator {
      // ... (identique, netLocation adapt√©)
    }

    // Event Listeners
    UIManager.$('themeToggle').addEventListener('change', () => {
      DataManager.theme = UIManager.$('themeToggle').checked ? 'light' : 'dark';
      UIManager.applyTheme();
    });
    // ... (autres events)

    // Init
    DataManager.autoBackup();
    // ... (init)

    // Ajout pour preview sur load tab
    document.querySelectorAll('#locations input, #locations select').forEach(el => el.addEventListener('input', updatePreview));
  </script>
</body>
</html>
