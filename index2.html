<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ROI - Flotte Auto (v11)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.32/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root { --bg1:#0b0d10; --bg2:#111418; --card:rgba(22,26,32,.72); --text:#e7e9ee; --muted:#a4acb9; --border:rgba(255,255,255,.08); --ring:#7dd3fc; --primary:#4f46e5; --primary-d:#4338ca; --pos:#16a34a; --neg:#ef4444; --warn:#f59e0b; }
    .light{ --bg1:#f7f8fb; --bg2:#eef1f6; --card:rgba(255,255,255,.9); --text:#0f172a; --muted:#5b6576; --border:rgba(15,15,30,.12); --ring:#0ea5e9; --primary:#2563eb; --primary-d:#1e40af; --pos:#16a34a; --neg:#ef4444; --warn:#f59e0b; }
    body{ min-height:100vh; background: radial-gradient(1000px 600px at 15% -10%, rgba(79,70,229,.14), transparent 60%), radial-gradient(900px 560px at 100% 10%, rgba(14,165,233,.12), transparent 55%), linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:1rem; padding:1.1rem; backdrop-filter: blur(8px); }
    .btn{ background:linear-gradient(180deg,var(--primary),var(--primary-d)); color:#fff; padding:.55rem .95rem; border-radius:.7rem; font-weight:700; }
    .btn-ghost{ background:transparent; border:1px solid var(--border); border-radius:.7rem; padding:.5rem .8rem; color:var(--text); }
    input,select{ background:rgba(255,255,255,.03); color:var(--text); border:1px solid var(--border); border-radius:.6rem; padding:.55rem .65rem; width:100%; transition:border-color .2s; }
    input.error{ border-color:var(--neg); box-shadow:0 0 0 2px rgba(239,68,68,.2); }
    input.valid{ border-color:var(--pos); box-shadow:0 0 0 2px rgba(22,163,74,.2); }
    label{ color:var(--muted); font-size:.9rem; }
    table{ width:100%; border-collapse:collapse; } th,td{ border-bottom:1px solid var(--border); padding:.55rem .6rem; } th{ color:var(--muted); text-align:left; }
    .pill{ font-size:.75rem; font-weight:800; padding:.2rem .55rem; border-radius:999px; }
    .grid-2{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; }
    .grid-3{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; }
    .grid-4{ display:grid; grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; }
    @media(min-width:768px){ .grid-2{ grid-template-columns:repeat(2,1fr); } .grid-3{ grid-template-columns:repeat(3,1fr); } .grid-4{ grid-template-columns:repeat(4,1fr); } }
    .toggle{ display:flex; align-items:center; gap:.5rem; cursor:pointer; }
    .toggle input{ width:2.6rem; height:1.35rem; appearance:none; border:1px solid var(--border); border-radius:999px; position:relative; background:rgba(255,255,255,.08); }
    .toggle input:checked{ background:linear-gradient(180deg,var(--primary),var(--primary-d)); }
    .toggle input:before{ content:""; position:absolute; top:2px; left:2px; width:1.05rem; height:1.05rem; background:#fff; border-radius:999px; transition:all .18s ease; }
    .toggle input:checked:before{ transform:translateX(1.2rem); }
    .hint{ color:var(--muted); font-size:.85rem; }
    .row-selected{ outline:2px solid var(--ring); background:rgba(125,211,252,.08); }
    .compact table th, .compact table td{ padding:.25rem .35rem; }
    .compact .pill{ font-size:.7rem; padding:.15rem .4rem; }
    .toast{ position:fixed; top:20px; right:20px; padding:1rem 1.5rem; border-radius:.5rem; color:#fff; z-index:1000; transform:translateX(100%); transition:transform .3s; font-weight:500; }
    .toast.show{ transform:translateX(0); }
    .occ-badge, .alert-badge{ padding:.2rem .5rem; border-radius:.5rem; font-size:.8rem; font-weight:600; }
    .occ-good{ background:var(--pos); color:#fff; }
    .occ-warn{ background:var(--warn); color:#fff; }
    .occ-bad{ background:var(--neg); color:#fff; }
    .alert-warn{ background:var(--warn); color:#fff; }
    .alert-bad{ background:var(--neg); color:#fff; }
    .highlight{ background:rgba(79,70,229,.2); }
    .quick-stats{ display:flex; justify-content:space-around; flex-wrap:wrap; gap:1rem; margin-bottom:1rem; }
    .stat-card{ flex:1; min-width:150px; text-align:center; padding:1rem; border-radius:.75rem; background:var(--card); }
    .preview-breakdown{ background:var(--card); border-radius:.75rem; padding:1rem; margin-top:1rem; }
    .breakdown-line{ display:flex; justify-content:space-between; margin:.25rem 0; }
    .breakdown-total{ font-weight:bold; border-top:1px solid var(--border); padding-top:.5rem; margin-top:.5rem; }
    @media (max-width: 480px) { .grid-4 { grid-template-columns: repeat(2, 1fr); } .btn { padding: .4rem .8rem; font-size: .875rem; } .quick-stats { flex-direction:column; } }
  </style>
</head>
<body>
  <header class="mb-6 max-w-7xl mx-auto px-4">
    <div class="flex items-center justify-between gap-4">
      <h1 class="text-2xl font-extrabold">üìä Dashboard ROI ‚Äì Flotte Auto (v11)</h1>
      <div class="flex flex-wrap items-center gap-2">
        <label class="toggle" title="Basculer th√®me clair/sombre"><span class="hint">Th√®me clair</span><input type="checkbox" id="themeToggle"/></label>
        <button id="exportJson" class="btn-ghost">Export JSON</button>
        <label class="btn-ghost cursor-pointer">Import JSON<input id="importJson" type="file" accept="application/json" class="hidden"/></label>
        <button id="exportCsv" class="btn-ghost">Export CSV</button>
        <button id="exportPdf" class="btn-ghost">Export PDF</button>
      </div>
    </div>
    <div id="quickStats" class="quick-stats hidden"></div>
    <div class="mt-4 flex flex-wrap gap-2">
      <button class="btn" onclick="UIManager.showTab('locations')">Locations r√©elles</button>
      <button class="btn" onclick="UIManager.showTab('vehicles')">V√©hicules</button>
      <button class="btn" onclick="UIManager.showTab('suivi')">Suivi mensuel</button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 space-y-6">
    <!-- LOCATIONS (Modifi√© pour saisie simplifi√©e avec preview breakdown) -->
    <section id="locations" class="card hidden">
      <h2 class="text-xl font-semibold mb-3">üìÖ Locations r√©elles</h2>
      <p class="hint mb-3">Saisie simplifi√©e : Remplis les bases, vois le breakdown auto, et enregistre. Commission globale et usure via Globals/V√©hicules.</p>
      <div class="grid-4">
        <div><label>D√©but *</label><input type="date" id="date" required oninput="updatePreview()"/></div>
        <div><label>Fin (auto si jours)</label><input type="date" id="endDate" oninput="updatePreview()"/></div>
        <div><label>Jours *</label><input type="number" id="jours" min="1" value="1" required oninput="updatePreview()"/></div>
        <div><label>V√©hicule *</label><select id="vehicule" required onchange="updatePreview()"></select></div>
        <div><label>Tarif total (‚Ç¨) *</label><input type="number" id="tarifTotal" min="0.01" step="0.1" value="44" required oninput="updatePreview()"/></div>
        <div><label>Km inclus (d√©faut 400)</label><input type="number" id="kmInclus" min="0" value="400" oninput="updatePreview()"/></div>
        <div><label>Km parcourus (total)</label><input type="number" id="kms" min="0" step="1" placeholder="ex. 427" oninput="updatePreview()"/></div>
        <div><label>Frais service (%) (d√©faut 10)</label><input type="number" id="fraisServicePct" min="0" max="100" value="10" step="0.1" oninput="updatePreview()"/></div>
        <div class="md:col-span-2"><label>Notes</label><input type="text" id="notes" placeholder="Ex. #week-end #pro, remise‚Ä¶" oninput="updatePreview()"/></div>
      </div>
      <!-- Preview Breakdown (comme l'image) -->
      <div id="previewBreakdown" class="preview-breakdown hidden">
        <h3 class="text-sm font-semibold mb-2">Pr√©visualisation Revenus</h3>
        <div class="breakdown-line"><span>Tarif base</span><span id="prevTarif" class="text-right">0‚Ç¨</span></div>
        <div class="breakdown-line"><span>Frais service (<span id="prevFraisPct">10</span>%)</span><span id="prevFrais" class="text-right">0‚Ç¨</span></div>
        <div class="breakdown-line"><span>Carburant surplus (<span id="prevExtraKm">0</span> km √ó 0.14‚Ç¨)</span><span id="prevCarburant" class="text-right">0‚Ç¨</span></div>
        <div class="breakdown-line"><span>Usure & extras (auto)</span><span id="prevUsure" class="text-right">0‚Ç¨</span></div>
        <div class="breakdown-total"><span>Vos revenus net</span><span id="prevNet" style="color:var(--pos);">0‚Ç¨</span></div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="saveBtn" class="btn" onclick="LocationManager.save()">Enregistrer</button>
        <button id="cancelEditBtn" class="btn-ghost hidden" onclick="LocationManager.cancelEdit()">Annuler</button>
        <select id="filterVehicule" class="w-auto"></select>
        <input type="month" id="filterMonth" class="w-auto"/>
        <input type="text" id="filterNotes" class="w-auto" placeholder="#tag, notes, texte" style="min-width:180px"/>
        <label class="toggle" title="Mode compact du tableau"><span class="hint">Compact</span><input type="checkbox" id="compactToggle"/></label>
        <button class="btn-ghost" onclick="UIManager.clearFilters()">Effacer filtres</button>
      </div>
      <div class="mt-4 overflow-x-auto">
        <table>
          <thead><tr><th>Date</th><th>Jours</th><th>Tarif ‚Ç¨</th><th>Km</th><th>Frais %</th><th>Carb. ¬±</th><th>V√©hicule</th><th>Net loc</th><th>Notes</th><th>Actions</th></tr></thead>
          <tbody id="locTable"></tbody>
        </table>
      </div>
      <p class="text-sm mt-2 hint">Net = Tarif total √ó (1 - frais%) - (km extra √ó 0.14‚Ç¨) - usure - extras. Override possible via edit.</p>
    </section>

    <!-- VEHICLES (inchang√©) -->
    <section id="vehicles" class="card hidden">
      <h2 class="text-xl font-semibold mb-3">üöó V√©hicules</h2>
      <div class="mb-3 flex flex-wrap gap-2">
        <button class="btn" onclick="VehicleManager.add()">+ Ajouter un v√©hicule</button>
      </div>
      <div id="vehiclesList" class="grid-2"></div>
    </section>

    <!-- SUIVI (inchang√©) -->
    <section id="suivi" class="card hidden">
      <h2 class="text-xl font-semibold mb-1">üìä Suivi mensuel</h2>
      <p class="hint mb-3">Astuce : choisis un v√©hicule pour voir <b>uniquement</b> ses r√©sultats. ‚ÄúTous v√©hicules‚Äù additionne tout (net ventil√© <b>jour par jour</b>). Badge d‚Äôoccupation = jours lou√©s / capacit√©.</p>
      <div class="flex flex-wrap items-center gap-2 mb-3">
        <select id="suiviVehicule" class="w-auto"></select>
        <input type="month" id="suiviMonth" class="w-auto" />
        <label class="toggle" title="Afficher la marge (%) au lieu des ‚Ç¨">
          <span class="hint">Mode %</span>
          <input type="checkbox" id="modePercent"/>
        </label>
        <button id="exportSuiviCsv" class="btn-ghost">Export Suivi (CSV)</button>
      </div>
      <div id="globalROI" class="card mb-3 p-4 text-center">
        <h3 class="text-lg font-bold">ROI Global</h3>
        <p id="roiValue" class="text-2xl" style="color:var(--neg);">‚Äî</p>
        <p class="hint">Cumul net / Investissement total</p>
      </div>
      <div id="priceSuggestion" class="card mb-3 p-2 text-center hidden">
        <p class="hint">Suggestion prix : <span id="suggText">‚Äî</span></p>
      </div>
      <div class="grid-3">
        <div><canvas id="chartNet" height="150"></canvas></div>
        <div><canvas id="chartCumul" height="150"></canvas></div>
        <div><canvas id="chartPredict" height="150"></canvas></div>
      </div>
      <div id="monthTop" class="mt-3 text-sm"></div>
      <div id="monthBreakdown" class="mt-2 grid-2"></div>
      <div class="mt-4 overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>Mois</th>
              <th>Net avant fixes (‚Ç¨)</th>
              <th>Fixes (‚Ç¨)</th>
              <th>Net apr√®s (‚Ç¨)</th>
              <th>Marge (%)</th>
              <th>Occupation</th>
              <th>VNC (‚Ç¨)</th>
            </tr>
          </thead>
          <tbody id="suiviTable"></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    // ===== Managers (Modular JS - v11 avec saisie simplifi√©e locations) =====
    class DataManager {
      static KEY = 'roi_multi_v11_suivi_vnc_percent_table';
      static UIKEY = 'roi_ui_v11';
      static data = JSON.parse(localStorage.getItem(this.KEY) || '{}');
      static ui = JSON.parse(localStorage.getItem(this.UIKEY) || '{"compact":false,"selectedId":null}');

      static get theme() { return this.data.theme || 'dark'; }
      static set theme(val) { this.data.theme = val; this.saveAll(); }

      static saveAll() {
        localStorage.setItem(this.KEY, JSON.stringify({theme: this.theme, vehicles: VehicleManager.vehicles, globals: GlobalManager.globals, locations: LocationManager.locations}));
        localStorage.setItem(this.UIKEY, JSON.stringify(this.ui));
      }

      static validateLocation(obj) {
        const errors = [];
        if (!obj.date) errors.push('Date requise');
        if (obj.jours < 1) errors.push('Jours ‚â•1');
        if (obj.tarifTotal <= 0) errors.push('Tarif >0');
        if (!obj.vehiculeId || !VehicleManager.getById(obj.vehiculeId)) errors.push('V√©hicule requis');
        return errors;
      }

      static showToast(msg, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.style.background = type === 'error' ? 'var(--neg)' : type === 'success' ? 'var(--pos)' : 'var(--primary)';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
      }

      static autoBackup() {
        setInterval(() => {
          if (confirm('Sauvegarde auto d√©tect√©e. Exporter maintenant ?')) {
            UIManager.exportJson();
          }
        }, 300000); // 5min
      }

      static importData(imported) {
        try {
          if (imported.theme) this.theme = imported.theme;
          if (Array.isArray(imported.vehicles)) {
            VehicleManager.vehicles = imported.vehicles.map(v => ({
              ...v,
              costs: {
                ...v.costs,
                residual: v.costs?.residual ?? 0,
                useWear: v.costs?.useWear ?? false,
                acqStart: v.costs?.acqStart ?? '',
                kmActuels: v.costs?.kmActuels ?? 0,
                maintenanceIntervalKm: v.costs?.maintenanceIntervalKm ?? 15000
              }
            }));
          }
          if (imported.globals) GlobalManager.globals = imported.globals;
          if (Array.isArray(imported.locations)) {
            LocationManager.locations = imported.locations.map(l => ({
              ...l,
              netOverride: (l.netOverride !== undefined ? l.netOverride : (l.net_recu !== undefined ? l.net_recu : null)),
              tarifTotal: l.tarifTotal || (l.prixJour * l.jours), // Migration prixJour vers tarifTotal
              fraisServicePct: l.fraisServicePct || 10,
              kmInclus: l.kmInclus || 400
            }));
          }
          this.saveAll();
          VehicleManager.render();
          LocationManager.fillVehSelect();
          UIManager.fillFilters();
          LocationManager.renderTable();
          SuiviManager.render();
          DataManager.showToast('Import r√©ussi ‚úÖ', 'success');
        } catch (e) {
          DataManager.showToast('Fichier invalide ‚ùå', 'error');
        }
      }
    }

    function validateInput(el) {
      const val = el.value.trim();
      if (el.required && !val) {
        el.classList.add('error');
        el.classList.remove('valid');
      } else if (el.type === 'number' && Number(val) < (el.min || 0)) {
        el.classList.add('error');
        el.classList.remove('valid');
      } else {
        el.classList.remove('error');
        el.classList.add('valid');
      }
    }

    function updatePreview() {
      const date = UIManager.$('date').value;
      const jours = Number(UIManager.$('jours').value || 1);
      const tarifTotal = Number(UIManager.$('tarifTotal').value || 0);
      const kmInclus = Number(UIManager.$('kmInclus').value || 400);
      const kms = Number(UIManager.$('kms').value || 0);
      const fraisServicePct = Number(UIManager.$('fraisServicePct').value || 10) / 100;
      const vehId = UIManager.$('vehicule').value;
      const v = VehicleManager.getById(vehId);
      const com = (GlobalManager.globals.commission || 10) / 100;
      const wearRate = GlobalManager.globals.wearPerKm || 0.12;

      if (!date || !vehId || tarifTotal <= 0) {
        UIManager.$('previewBreakdown').classList.add('hidden');
        return;
      }

      const extraKm = Math.max(0, kms - kmInclus);
      const fraisService = tarifTotal * fraisServicePct;
      const carburantSurplus = extraKm * 0.14; // Taux fixe 0.14‚Ç¨/km extra, n√©gatif pour surplus
      const usure = v?.costs?.useWear ? (kms * wearRate) : 0;
      const net = tarifTotal * (1 - com - fraisServicePct) - carburantSurplus - usure; // Simplifi√©, sans extras/fuelAdj pour preview

      UIManager.$('prevTarif').textContent = `${tarifTotal.toFixed(2)}‚Ç¨`;
      UIManager.$('prevFraisPct').textContent = (fraisServicePct * 100).toFixed(1);
      UIManager.$('prevFrais').textContent = `-${fraisService.toFixed(2)}‚Ç¨`;
      UIManager.$('prevExtraKm').textContent = extraKm;
      UIManager.$('prevCarburant').textContent = `-${carburantSurplus.toFixed(2)}‚Ç¨`;
      UIManager.$('prevUsure').textContent = `-${usure.toFixed(2)}‚Ç¨`;
      UIManager.$('prevNet').textContent = `${net.toFixed(2)}‚Ç¨`;
      UIManager.$('prevNet').style.color = net >= 0 ? 'var(--pos)' : 'var(--neg)';

      UIManager.$('previewBreakdown').classList.remove('hidden');
    }

    class UIManager {
      static $(id) { return document.getElementById(id); }
      static currentTab = 'suivi';

      static applyTheme() {
        const toggle = this.$('themeToggle');
        if (!toggle.checked && DataManager.theme === 'light') toggle.checked = true;
        toggle.checked ? document.documentElement.classList.add('light') : document.documentElement.classList.remove('light');
        document.body.classList.toggle('compact', !!DataManager.ui.compact);
      }

      static showTab(id) {
        document.querySelectorAll('section.card').forEach(s => s.classList.add('hidden'));
        this.$(id).classList.remove('hidden');
        this.currentTab = id;
        if (id === 'suivi') SuiviManager.render();
        if (id === 'vehicles') VehicleManager.render();
        if (id === 'locations') {
          LocationManager.renderTable();
          updatePreview(); // Refresh preview
        }
      }

      static clearFilters() {
        this.$('filterVehicule').value = 'ALL';
        this.$('filterMonth').value = '';
        this.$('filterNotes').value = '';
        LocationManager.renderTable();
      }

      static fillFilters() {
        const filt = this.$('filterVehicule');
        filt.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = 'ALL';
        optAll.textContent = 'Tous v√©hicules';
        filt.appendChild(optAll);
        VehicleManager.vehicles.filter(v => v.active).forEach(v => {
          const o = document.createElement('option');
          o.value = v.id;
          o.textContent = v.name;
          filt.appendChild(o);
        });
      }

      static exportJson() {
        const blob = new Blob([JSON.stringify(DataManager.data, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `roi-data-${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 0);
        DataManager.showToast('Export JSON OK !', 'success');
      }

      static exportCsv() {
        const headers = ['Date', 'Jours', 'Tarif ‚Ç¨', 'Km', 'Frais %', 'Carb. ¬±', 'V√©hicule', 'Net loc', 'Notes'];
        const rows = LocationManager.locations.map(l => [
          l.date,
          l.jours,
          l.tarifTotal.toFixed(2),
          l.kms || '',
          l.fraisServicePct || 10,
          (l.kms - (l.kmInclus || 400)) * 0.14,
          VehicleManager.getById(l.vehiculeId)?.name || '',
          Calculator.netLocation(l).toFixed(2),
          l.notes || ''
        ]);
        const csv = [headers.join(';'), ...rows.map(row => row.join(';'))].join('\n');
        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `locations-${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 0);
        DataManager.showToast('Export CSV OK !', 'success');
      }

      static exportPdf() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text('Suivi ROI Flotte Auto', 10, 10);
        const rows = window.__lastSuiviRows || [];
        let body = rows.map(r => [r.m, r.beforeVal.toFixed(2), r.fixesVal.toFixed(2), r.afterVal.toFixed(2), r.margePct.toFixed(0), r.occStr, r.vnc.toFixed(2)]);
        if (window.predictData) {
          body = body.map((row, i) => [...row, window.predictData[i] ? window.predictData[i].toFixed(2) : '‚Äî']);
        }
        doc.autoTable({
          head: window.predictData ? [['Mois', 'Net avant (‚Ç¨)', 'Fixes (‚Ç¨)', 'Net apr√®s (‚Ç¨)', 'Marge (%)', 'Occupation', 'VNC (‚Ç¨)', 'Pr√©diction (‚Ç¨)']] : [['Mois', 'Net avant (‚Ç¨)', 'Fixes (‚Ç¨)', 'Net apr√®s (‚Ç¨)', 'Marge (%)', 'Occupation', 'VNC (‚Ç¨)']],
          body
        });
        doc.save(`suivi-roi-${new Date().toISOString().slice(0,10)}.pdf`);
        DataManager.showToast('Export PDF OK !', 'success');
      }
    }

    class GlobalManager {
      static globals = DataManager.data.globals || { commission: 10, wearPerKm: 0.12, kmInclus: 400 }; // Ajout kmInclus global
    }

    class VehicleManager {
      static vehicles = DataManager.data.vehicles || [
        { id: 'clio', name: 'Clio', active: true, costs: { ass: 56, conn: 25, ent: 45, totalInvested: 11659, residual: 0, amortMonths: 60, useWear: false, acqStart: '', kmActuels: 0, maintenanceIntervalKm: 15000 } },
        { id: 'tesla', name: 'Tesla', active: true, costs: { ass: 115, conn: 0, ent: 30, totalInvested: 0, residual: 0, amortMonths: 60, useWear: false, acqStart: '', kmActuels: 0, maintenanceIntervalKm: 15000 } }
      ];

      static getById(id) { return this.vehicles.find(v => v.id === id); }

      static monthlyAmort(v) {
        const c = v.costs || {};
        const months = Math.max(1, Number(c.amortMonths || 0));
        let base = Number(c.totalInvested || 0) - Number(c.residual || 0);
        if (base < 0) base = 0;
        return base / months;
      }

      static fixedCostsMonthly(v) {
        const c = v.costs || {};
        return (c.ass || 0) + (c.conn || 0) + (c.ent || 0) + this.monthlyAmort(v);
      }

      static fixedCostsBreakdown(v) {
        const c = v.costs || {};
        return {
          ass: c.ass || 0,
          conn: c.conn || 0,
          ent: c.ent || 0,
          amort: this.monthlyAmort(v),
          base: Math.max(0, (c.totalInvested || 0) - (c.residual || 0)),
          months: Math.max(1, Number(c.amortMonths || 0))
        };
      }

      static vncForVehicleAtMonth(v, monthKeyStr) {
        const c = v.costs || {};
        const amort = this.monthlyAmort(v);
        const base = Math.max(0, (c.totalInvested || 0) - (c.residual || 0));
        const start = c.acqStart || SuiviManager.firstActivityMonthForVeh(v.id) || monthKeyStr;
        const elapsed = Math.max(0, Calculator.monthDiffInclusive(start, monthKeyStr) - 1);
        const depreciated = Math.min(base, amort * elapsed);
        const vnc = (c.totalInvested || 0) - depreciated;
        return Math.max(vnc, c.residual || 0);
      }

      static render() {
        const active = this.vehicles.filter(v => v.active);
        ['vehicule', 'filterVehicule', 'suiviVehicule'].forEach(id => {
          const el = UIManager.$(id);
          if (!el) return;
          el.innerHTML = '';
          if (id === 'filterVehicule' || id === 'suiviVehicule') {
            const optAll = document.createElement('option');
            optAll.value = 'ALL';
            optAll.textContent = 'Tous v√©hicules';
            el.appendChild(optAll);
          }
          active.forEach(v => {
            const o = document.createElement('option');
            o.value = v.id;
            o.textContent = v.name;
            el.appendChild(o);
          });
        });
        const sel = UIManager.$('suiviVehicule');
        const firstActive = this.vehicles.find(v => v.active);
        if (firstActive && (!sel.dataset.setOnce || sel.value === 'ALL')) {
          sel.value = firstActive.id;
          sel.dataset.setOnce = '1';
        }

        const wrap = UIManager.$('vehiclesList');
        wrap.innerHTML = '';
        this.vehicles.forEach(v => {
          const c = v.costs || {};
          const amort = this.monthlyAmort(v);
          const kmOver = c.kmActuels > c.maintenanceIntervalKm;
          const monthsSince = c.acqStart ? Calculator.monthDiffInclusive(c.acqStart, new Date().toISOString().slice(0,7)) : 0;
          const maintOver = monthsSince > 12;
          const alertClass = (kmOver || maintOver) ? (kmOver && maintOver ? 'alert-bad' : 'alert-warn') : '';
          const alertText = [];
          if (kmOver) alertText.push('Km √©lev√©');
          if (maintOver) alertText.push('Maint. due');
          const alertBadge = alertText.length ? `<span class="pill ${alertClass}" title="Km: ${c.kmActuels}/${c.maintenanceIntervalKm}. Mois: ${monthsSince}">${alertText.join('+')}</span>` : '<span class="pill" style="background:var(--pos);color:#fff;">OK</span>';
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="flex items-center justify-between">
              <input value="${v.name}" data-id="${v.id}" class="veh-name" style="max-width:240px"/>
              <label class="toggle"><span class="hint">Actif</span><input type="checkbox" ${v.active ? 'checked' : ''} data-id="${v.id}" class="veh-active"/></label>
            </div>
            <div class="grid-4 mt-3">
              <div><label>Assurance / mois</label><input type="number" step="0.1" value="${c.ass || 0}" class="veh-ass" data-id="${v.id}"/></div>
              <div><label>Connect / mois</label><input type="number" step="0.1" value="${c.conn || 0}" class="veh-conn" data-id="${v.id}"/></div>
              <div><label>Entretien / mois</label><input type="number" step="0.1" value="${c.ent || 0}" class="veh-ent" data-id="${v.id}"/></div>
              <div><label>Amort. (auto) / mois</label><input type="number" value="${amort.toFixed(2)}" disabled/></div>
            </div>
            <div class="grid-4 mt-3">
              <div><label>Total investi (‚Ç¨)</label><input type="number" step="0.1" value="${c.totalInvested || 0}" class="veh-total" data-id="${v.id}"/></div>
              <div><label>Valeur r√©siduelle estim√©e (‚Ç¨)</label><input type="number" step="0.1" value="${c.residual || 0}" class="veh-resid" data-id="${v.id}"/></div>
              <div><label>Dur√©e amort. (mois)</label><input type="number" value="${c.amortMonths || 60}" class="veh-months" data-id="${v.id}"/></div>
              <div><label>D√©but amort. (YYYY-MM)</label><input type="month" value="${c.acqStart || ''}" class="veh-acqstart" data-id="${v.id}"/></div>
            </div>
            <div class="grid-4 mt-3">
              <div><label>Km actuels</label><input type="number" value="${c.kmActuels || 0}" class="veh-km" data-id="${v.id}"/></div>
              <div><label>Intervalle maint. Km</label><input type="number" value="${c.maintenanceIntervalKm || 15000}" class="veh-maintkm" data-id="${v.id}"/></div>
              <div><label>Base amortissable</label><input type="text" value="${Math.max(0, (c.totalInvested || 0) - (c.residual || 0)).toFixed(2)} ‚Ç¨" disabled/></div>
              <div><label>Formule</label><input type="text" value="(Total - R√©siduelle) √∑ Mois" disabled/></div>
            </div>
            <div class="mt-2">
              <label class="toggle">
                <span class="hint">Usure/km activ√©e (utilise le co√ªt/km global)</span>
                <input type="checkbox" ${c.useWear ? 'checked' : ''} data-id="${v.id}" class="veh-usewear"/>
              </label>
              ${alertBadge}
            </div>
            <div class="mt-3 flex gap-2">
              <button class="btn" onclick="VehicleManager.saveAll()">üíæ Sauvegarder</button>
              <button class="btn-ghost" onclick="VehicleManager.remove('${v.id}')">Supprimer</button>
            </div>`;
          wrap.appendChild(card);
        });

        // Wire inputs (inchang√©, + veh-km et veh-maintkm)
        wrap.querySelectorAll('.veh-name').forEach(i => i.oninput = e => {
          const v = this.getById(e.target.dataset.id);
          if (v) { v.name = e.target.value; DataManager.saveAll(); this.render(); }
        });
        // ... (tous les autres wires identiques √† v10)
        wrap.querySelectorAll('.veh-km').forEach(i => i.oninput = e => {
          const v = this.getById(e.target.dataset.id);
          if (v) { v.costs.kmActuels = Number(e.target.value || 0); DataManager.saveAll(); this.render(); }
        });
        wrap.querySelectorAll('.veh-maintkm').forEach(i => i.oninput = e => {
          const v = this.getById(e.target.dataset.id);
          if (v) { v.costs.maintenanceIntervalKm = Number(e.target.value || 15000); DataManager.saveAll(); this.render(); }
        });
      }

      static add() {
        const id = 'veh_' + Math.random().toString(36).slice(2, 8);
        this.vehicles.push({
          id,
          name: 'Nouveau v√©hicule',
          active: true,
          costs: { ass: 0, conn: 0, ent: 0, totalInvested: 0, residual: 0, amortMonths: 60, useWear: false, acqStart: '', kmActuels: 0, maintenanceIntervalKm: 15000 }
        });
        DataManager.saveAll();
        this.render();
        LocationManager.fillVehSelect();
        updatePreview();
      }

      static remove(id) {
        if (!confirm('Supprimer ce v√©hicule ?')) return;
        this.vehicles = this.vehicles.filter(v => v.id !== id);
        LocationManager.locations = LocationManager.locations.filter(l => l.vehiculeId !== id);
        DataManager.saveAll();
        this.render();
        LocationManager.renderTable();
        SuiviManager.render();
      }

      static saveAll() {
        DataManager.saveAll();
        DataManager.showToast('V√©hicules sauvegard√©s ‚úÖ', 'success');
      }
    }

    class LocationManager {
      static locations = (DataManager.data.locations || []).map(l => ({
        ...l,
        netOverride: (l.netOverride !== undefined ? l.netOverride : (l.net_recu !== undefined ? l.net_recu : null)),
        tarifTotal: l.tarifTotal || (l.prixJour * l.jours || 0),
        fraisServicePct: l.fraisServicePct || 10,
        kmInclus: l.kmInclus || 400,
        prixJour: undefined // Migration vers tarifTotal
      }));
      static editId = null;

      static save() {
        const date = UIManager.$('date').value;
        const endDate = UIManager.$('endDate').value;
        const jours = Number(UIManager.$('jours').value || 1);
        const tarifTotal = Number(UIManager.$('tarifTotal').value || 0);
        const kmInclus = Number(UIManager.$('kmInclus').value || 400);
        const kms = Number(UIManager.$('kms').value || 0);
        const fraisServicePct = Number(UIManager.$('fraisServicePct').value || 10);
        const notes = UIManager.$('notes').value || '';
        const vehiculeId = UIManager.$('vehicule').value;
        const inputs = {
          date,
          endDate,
          jours,
          tarifTotal,
          kmInclus,
          kms,
          fraisServicePct,
          notes,
          vehiculeId,
          netOverride: null // Calcul auto, override via edit
        };
        const errors = DataManager.validateLocation(inputs);
        if (errors.length) {
          errors.forEach(e => DataManager.showToast(e, 'error'));
          return;
        }
        if (this.editId) {
          this.locations = this.locations.map(l => l.id === this.editId ? { ...l, ...inputs } : l);
          this.editId = null;
          UIManager.$('cancelEditBtn').classList.add('hidden');
          UIManager.$('saveBtn').textContent = 'Enregistrer';
        } else {
          const id = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())) + Math.random().toString(36).slice(2, 6);
          this.locations.push({ id, ...inputs });
        }
        DataManager.saveAll();
        this.clearForm();
        this.renderTable();
        SuiviManager.render();
        DataManager.showToast('Location sauvegard√©e !', 'success');
      }

      static cancelEdit() {
        this.editId = null;
        this.clearForm();
        UIManager.$('cancelEditBtn').classList.add('hidden');
        UIManager.$('saveBtn').textContent = 'Enregistrer';
      }

      static clearForm() {
        UIManager.$('date').value = '';
        UIManager.$('endDate').value = '';
        UIManager.$('jours').value = 1;
        UIManager.$('tarifTotal').value = '';
        UIManager.$('kmInclus').value = '400';
        UIManager.$('kms').value = '';
        UIManager.$('fraisServicePct').value = '10';
        UIManager.$('notes').value = '';
        UIManager.$('vehicule').value = '';
        UIManager.$('previewBreakdown').classList.add('hidden');
      }

      static remove(id) {
        this.locations = this.locations.filter(l => l.id !== id);
        DataManager.saveAll();
        this.renderTable();
        SuiviManager.render();
      }

      static edit(id) {
        const l = this.locations.find(x => x.id === id);
        if (!l) return;
        this.editId = id;
        UIManager.$('date').value = l.date || '';
        UIManager.$('endDate').value = l.endDate || '';
        UIManager.$('jours').value = l.jours ?? 1;
        UIManager.$('tarifTotal').value = l.tarifTotal ?? '';
        UIManager.$('kmInclus').value = l.kmInclus ?? '400';
        UIManager.$('kms').value = l.kms ?? '';
        UIManager.$('fraisServicePct').value = l.fraisServicePct ?? '10';
        UIManager.$('notes').value = l.notes || '';
        UIManager.$('vehicule').value = l.vehiculeId;
        UIManager.$('cancelEditBtn').classList.remove('hidden');
        UIManager.$('saveBtn').textContent = 'Mettre √† jour';
        updatePreview();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      static duplicate(id) {
        const l = this.locations.find(x => x.id === id);
        if (!l) return;
        const copy = {
          ...l,
          id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())) + Math.random().toString(36).slice(2, 6),
          notes: (l.notes ? l.notes + " (dup)" : "(dup)")
        };
        this.locations.unshift(copy);
        DataManager.saveAll();
        this.renderTable();
        SuiviManager.render();
      }

      static makeEditable(td, initialValue, type, onSave, step) {
        const input = document.createElement('input');
        input.type = type || 'text';
        if (step) input.step = step;
        input.value = initialValue ?? '';
        input.style.width = '100%';
        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { input.blur(); } });
        input.addEventListener('blur', () => { onSave(input.value); });
        td.innerHTML = '';
        td.appendChild(input);
        input.focus();
        input.select?.();
      }

      static attachInlineEditors(tr, l) {
        const map = [
          { sel: '.cell-jours', field: 'jours', type: 'number' },
          { sel: '.cell-tarif', field: 'tarifTotal', type: 'number', step: '0.1' },
          { sel: '.cell-kms', field: 'kms', type: 'number' },
          { sel: '.cell-frais', field: 'fraisServicePct', type: 'number', step: '0.1' },
          { sel: '.cell-carb', field: 'fuelAdj', type: 'number', step: '0.1' }, // Carb. ¬± as fuelAdj
          { sel: '.cell-notes', field: 'notes', type: 'text' }
        ];
        map.forEach(({ sel, field, type, step }) => {
          const td = tr.querySelector(sel);
          if (!td) return;
          td.title = 'Double-clic pour √©diter';
          td.ondblclick = () => {
            const startVal = (field === 'notes') ? (l.notes || '') : Number(l[field] || 0);
            this.makeEditable(td, startVal, type, (val) => {
              if (field === 'notes') { l.notes = String(val || ''); } else { l[field] = Number(val || 0); }
              DataManager.saveAll();
              this.renderTable();
              SuiviManager.render();
            }, step);
          };
        });
        const tdNet = tr.querySelector('.cell-net');
        if (tdNet) {
          tdNet.title = 'Double-clic pour saisir un net re√ßu (override)';
          tdNet.ondblclick = () => {
            const startVal = (l.netOverride !== null && l.netOverride !== undefined) ? Number(l.netOverride) : Calculator.netLocation(l);
            this.makeEditable(tdNet, startVal, 'number', (val) => {
              const num = (val === null || val === '') ? null : Number(val);
              l.netOverride = (val === null || val === '') ? null : (Number.isNaN(num) ? null : num);
              DataManager.saveAll();
              this.renderTable();
              SuiviManager.render();
            }, '0.1');
          };
        }
      }

      static fillVehSelect() {
        const sel = UIManager.$('vehicule');
        sel.innerHTML = '';
        VehicleManager.vehicles.filter(v => v.active).forEach(v => {
          const o = document.createElement('option');
          o.value = v.id;
          o.textContent = v.name;
          sel.appendChild(o);
        });
        // Set kmInclus default from global
        UIManager.$('kmInclus').value = GlobalManager.globals.kmInclus || 400;
      }

      static renderTable() {
        const tbody = UIManager.$('locTable');
        tbody.innerHTML = '';
        const m = UIManager.$('filterMonth').value;
        const vf = UIManager.$('filterVehicule').value || 'ALL';
        const q = (UIManager.$('filterNotes').value || '').toLowerCase();
        const arr = this.locations.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).filter(l =>
          (!m || Calculator.monthKey(l.date) === m) &&
          (vf === 'ALL' || l.vehiculeId === vf) &&
          (!q || (l.notes || '').toLowerCase().includes(q))
        );
        for (const l of arr) {
          const v = VehicleManager.getById(l.vehiculeId);
          const net = Calculator.netLocation(l);
          const overrideUsed = (l.netOverride !== null && l.netOverride !== undefined && !Number.isNaN(Number(l.netOverride)));
          const tr = document.createElement('tr');
          tr.dataset.id = l.id;
          if (DataManager.ui.selectedId === l.id) tr.classList.add('row-selected');
          let notesHtml = l.notes || '';
          if (q && notesHtml.toLowerCase().includes(q)) {
            notesHtml = notesHtml.replace(new RegExp(q, 'gi'), match => `<mark class="highlight">${match}</mark>`);
          }
          const extraKm = Math.max(0, l.kms - (l.kmInclus || 400));
          const carb = extraKm * 0.14;
          tr.innerHTML = `
            <td class="cell-date">${l.date} ‚Üí ${l.endDate || ''}</td>
            <td class="cell-jours">${l.jours || 1}</td>
            <td class="cell-tarif">${(l.tarifTotal || 0).toFixed(2)}</td>
            <td class="cell-kms">${l.kms || '-'} (${extraKm} extra)</td>
            <td class="cell-frais">${l.fraisServicePct || 10}%</td>
            <td class="cell-carb">-${carb.toFixed(2)}</td>
            <td class="cell-veh">${v ? v.name : '‚Äî'}</td>
            <td class="cell-net">
              <span class="pill" style="background:${net >= 0 ? 'rgba(22,163,74,.18)' : 'rgba(239,68,68,.18)'};color:${net >= 0 ? '#16a34a' : '#ef4444'}" title="${overrideUsed ? 'Valeur saisie manuellement (override)' : 'Calcul automatique'}">${net.toFixed(2)}‚Ç¨</span>
              ${overrideUsed ? '<span class="ml-2 text-xs" style="padding:.1rem .4rem;border:1px solid var(--border);border-radius:.5rem;">Saisi</span>' : ''}
            </td>
            <td class="cell-notes" title="${(l.notes || '').replace(/"/g, '&quot;')}" style="max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${notesHtml}</td>
            <td class="whitespace-nowrap">
              <button class="btn-ghost" onclick="LocationManager.edit('${l.id}')">‚úèÔ∏è</button>
              <button class="btn-ghost" onclick="LocationManager.duplicate('${l.id}')">üìÑ</button>
              <button class="btn-ghost" onclick="LocationManager.remove('${l.id}')">üóëÔ∏è</button>
            </td>`;
          tr.addEventListener('click', () => {
            DataManager.ui.selectedId = l.id;
            DataManager.saveAll();
            this.renderTable();
          });
          tbody.appendChild(tr);
          this.attachInlineEditors(tr, l);
        }
      }
    }

    // ... (SuiviManager, Calculator inchang√©s de v10)

    class SuiviManager {
      // ... (code identique √† v10, avec simpleLinearRegression et render)
    }

    class Calculator {
      // Mise √† jour netLocation pour tarifTotal
      static netLocation(l) {
        if (l.netOverride !== null && l.netOverride !== undefined && !Number.isNaN(Number(l.netOverride))) {
          return Number(l.netOverride);
        }
        const com = (GlobalManager.globals.commission || 0) / 100;
        const fraisPct = (l.fraisServicePct || 10) / 100;
        const after = (l.tarifTotal || 0) * (1 - com - fraisPct);
        const v = VehicleManager.getById(l.vehiculeId);
        const wearRate = (GlobalManager.globals.wearPerKm || 0);
        const kmInclus = l.kmInclus || GlobalManager.globals.kmInclus || 400;
        const extraKm = Math.max(0, (l.kms || 0) - kmInclus);
        const carburantSurplus = extraKm * 0.14; // Taux fixe
        const wear = (v?.costs?.useWear ? ((l.kms || 0) * wearRate) : 0);
        return after - carburantSurplus - wear;
      }

      // ... (autres m√©thodes identiques)
    }

    // Event Listeners (ajout pour preview)
    document.querySelectorAll('#locations input, #locations select').forEach(el => el.addEventListener('input', updatePreview));

    // ... (autres events identiques √† v10)

    // Init (ajout fillVehSelect pour kmInclus)
    DataManager.autoBackup();
    // ... (init vehicles)
    UIManager.applyTheme();
    VehicleManager.render();
    LocationManager.fillVehSelect();
    UIManager.fillFilters();
    LocationManager.renderTable();
    UIManager.showTab('suivi');
  </script>
</body>
</html>
